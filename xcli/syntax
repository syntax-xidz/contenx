#!/bin/sh

cat << EOF
$(printf '\033[1;33m')           ▄▀▄     ▄▀▄ $(printf '\033[0m')
$(printf '\033[1;33m')          ▄█░░▀▀▀▀▀░░█▄ $(printf '\033[0m')
$(printf '\033[1;33m')      ▄▄  █░░░░░░░░░░█  ▄▄ $(printf '\033[0m')
$(printf '\033[1;33m')     █▄▄█ █░░▀░░┬░░▀░░█ █▄▄█ $(printf '\033[0m')
$(printf '\033[1;35m')▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄ $(printf '\033[0m')
$(printf '\033[1;35m')█$(printf '\033[1;39m') ▀▄▀ █ █▀▄ ▀█ █▀ █ █ █ █▀█ ▀█▀ $(printf '\033[1;35m')█ $(printf '\033[0m')
$(printf '\033[1;35m')█$(printf '\033[1;39m') █░█ █ █▄▀ █▄ ▄█ ▀▄▀▄▀ █▀▄ ░█░ $(printf '\033[1;35m')█ $(printf '\033[0m')
$(printf '\033[1;35m')█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█$(printf '\033[0m')
$(printf '\033[1;31m')──────────────────────────────────────────────────$(printf '\033[0m')
EOF

. /usr/share/libubox/jshn.sh

N="\e[0m"; V="\e[1;32m"; A="\e[1;31m"; M="\e[0;33m"; R="\e[2;33m"

uptime_str() {
    local u=$(cut -d. -f1 /proc/uptime)
    local d=$((u/86400)) h=$((u%86400/3600)) m=$((u%3600/60)) s=$((u%60))
    [ $d -gt 0 ] && printf "%dd " $d
    printf "%02d:%02d:%02d" $h $m $s
}

get_cpu_temp() {
    [ -f /sys/class/thermal/thermal_zone0/temp ] && 
    awk '{printf("%.1f°C", $1/1000)}' /sys/class/thermal/thermal_zone0/temp
}

get_cpu_freq() {
    [ -f /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq ] &&
    awk '{printf "%.2fGHz", $1/1000000}' /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq ||
    awk '/cpu MHz/{printf "%.2fGHz", $4/1000; exit}' /proc/cpuinfo
}

get_interface_label() {
    case "$1" in
        br-lan|lan*) echo "LAN" ;;
        eth*|wan*) echo "WAN" ;;
        wwan*) echo "WWAN" ;;
        usb*) echo "USB" ;;
        tailscale*) echo "TAIL" ;;
        wlan*) echo "WLAN" ;;
        *) echo "$(echo "$1" | tr '[a-z]' '[A-Z]')" ;;
    esac
}

human_readable() {
    [ $1 -gt 0 ] && awk -v n=$1 'BEGIN{for(i=split("B KB MB GB TB",s);x<1;i--)x=n/(2**(10*i));printf (int(x)==x)?"%.0f%s":"%.1f%s",x,s[i+2]}' || echo "0B"
}

device_rx_tx() {
    local rxtx=$(awk -v d=$1 '$1==d":"{printf "%.0f\t%.0f",$2,$10}' /proc/net/dev)
    [ "$rxtx" ] && printf " rx/tx: $R$(human_readable ${rxtx%	*})$N/$R$(human_readable ${rxtx#*	})$N"
}

distrib_id=$(awk -F"'" '/DISTRIB_ID/{print $2}' /etc/openwrt_release 2>/dev/null)
distrib_release=$(awk -F"'" '/DISTRIB_RELEASE/{print $2}' /etc/openwrt_release 2>/dev/null)
[ -n "$distrib_id" ] && [ -n "$distrib_release" ] && printf "Os     : ${V}$distrib_id $distrib_release${N}\n"

[ -f /tmp/sysinfo/model ] && printf "Model  : ${V}$(cat /tmp/sysinfo/model)${N}\n"

arch=$(awk '/CPU architecture/{print "ARMv"$3; exit}' /proc/cpuinfo 2>/dev/null)
[ -z "$arch" ] && arch=$(uname -m)
freq=$(get_cpu_freq)
temp=$(get_cpu_temp)
printf "Arch   : ${V}$arch${N}"
[ -n "$freq" ] && printf " ${N}| ${V}$freq${N}"
[ -n "$temp" ] && printf "  $temp"
printf "\n"

printf "Uptime : ${V}$(uptime_str)${N}, ${V}$(date +'%Y-%m-%d %H:%M:%S')${N}\n"

if [ -f /usr/lib/opkg/status ]; then
    total=$(df / | awk 'NR==2{print $2}')
    used=$(du -sk /overlay/upper 2>/dev/null | awk '{print $1}')
    [ -z "$used" ] && used=$(df /overlay | awk 'NR==2{print $3}')
    avail=$((total - used))
    printf "RootFS : ${V}%.0fMB${N}, used: ${V}%.0fMB${N}, free: ${V}%.0fMB${N}\n" \
        $((total/1024)) $((used/1024)) $((avail/1024))
else
    df / 2>/dev/null | awk 'NR==2 {
        printf "RootFS : \033[1;32m%.0fMB\033[0m, used: \033[1;32m%.0fMB\033[0m, free: \033[1;32m%.0fMB\033[0m\n", $2/1024, $3/1024, $4/1024
    }'
fi

awk '/^MemTotal:/{t=$2} /^MemFree:/{f=$2} /^Buffers:/{b=$2} /^Cached:/{c=$2}
END {
    used = t - f - b - c
    free = f + b + c
    printf "Memory : \033[1;32m%.0fMB\033[0m, used: \033[1;32m%.0fMB\033[0m, free: \033[1;32m%.0fMB\033[0m\n", t/1024, used/1024, free/1024
}' /proc/meminfo

status=$(ubus call network.wireless status 2>/dev/null)
if [ "$status" ]; then
    json_load "$status"
    json_get_keys radios
    for radio in $radios; do
        json_select "$radio"
        json_get_var up up
        [ "$up" = "1" ] || continue
        json_select config; json_get_var ch channel; json_select ..
        json_select interfaces; json_get_keys ifaces
        for iface in $ifaces; do
            json_select $iface
            json_get_var section section
            json_get_var ifname ifname
            json_select config
            json_get_var ssid ssid
            json_get_var mode mode
            [ "$ssid" ] && [ "$(uci -q get wireless.$section.disabled)" != "1" ] && {
                conn="Down"
                [ "$ifname" ] && {
                    [ "$mode" = "ap" ] && conn=$(iw dev $ifname station dump 2>/dev/null | grep -c Station) ||
                    conn=$(iw dev $ifname link 2>/dev/null | awk '/signal/{s=$2}/tx bitrate/{b=$3" "$4}END{print s" "b}')
                    [ "$ch" = "auto" ] && ch=$(iw dev $ifname info 2>/dev/null | awk '/channel/{print $2}')
                }
                printf "Wlan   : ${V}$ssid${N}($mode), ch: ${V}${ch:-n/a}${N}, conn: ${V}$conn${N}$(device_rx_tx $ifname)\n"
                break 2
            }
            json_select ..; json_select ..
        done
        json_select
    done
fi

count=0
ip -o addr show | awk '/inet / && !seen[$2]++ {
    if ($2 !~ /^lo$|^utun|^tun|^tap|^virbr|^docker|^veth/) {
        gsub(/\/.*/, "", $4)
        print $2":"$4
    }
}' | while IFS=: read -r iface ip && [ $count -lt 4 ]; do
    label=$(get_interface_label "$iface")
    printf "%-5s: ${A}%-15s${N}(${V}%s${N})\n" "$label" "$ip" "$iface"
    count=$((count + 1))
done

printf "${M}$(printf '%0.s─' $(seq 1 50))${N}\n"
printf "%17s${V}xidz_x | xdev${N}\n"
printf "${M}$(printf '%0.s─' $(seq 1 50))${N}\n"
