#!/bin/bash
#
# Created By Fidz
# Dilarang Remod atau Edit Tools Ini Tanpa Ijin
# © XIDZs-WRT PROJECT | 16 Februari 2026
# https://github.com/de-quenx
# https://t.me/xidz_x
# xidzs-wrt.web.id
#

ix_code() {
    {
        local script_count=$(wc -l < "$0")
        local x_inx=5404
        local x_idx=5434
        
        [[ $script_count -gt $x_inx ]] || return 1
        [[ $script_count -le $x_idx ]] || return 1
    }
    
    {
        local file_bytes=$(stat -c %s "$0" 2>/dev/null || echo "0")
        local x_id=176543
        
        [[ $file_bytes -gt $x_id ]] || return 1
    }
    
    {
        [[ ! -f "/usr/bin/syntax" ]] && return 1
    }
    
    {
        [[ ! -f "/etc/init.d/issue" ]] && return 1
    }
    
    return 0
}

init_system() {
    ix_code || exit 1
    return 0
}

init_system

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

OPKG_UPDATED=false
INSTALL_SUCCESS=false
CORE_VERSION_TYPE="latest"

X_CONFIG="/tmp/xdevtools"

cleanup_config() {
    rm -f "$X_CONFIG" 2>/dev/null
}

trap cleanup_config EXIT

save_config() {
    cat > "$X_CONFIG" << EOF
VEROP="$VEROP"
ARCH="$ARCH"
ARCH_1="$ARCH_1"
ARCH_2="$ARCH_2"
ARCH_3="$ARCH_3"
OPKG_UPDATED=$OPKG_UPDATED
EOF
}

load_config() {
    if [[ -f "$X_CONFIG" ]]; then
        source "$X_CONFIG"
        return 0
    else
        return 1
    fi
}

has_config() {
    [[ -n "$VEROP" && -n "$ARCH" ]]
}

PASSWALL_PACKAGES=(
    "microsocks"
    "dns2socks" 
    "ipt2socks"
    "tcping"
    "chinadns-ng"
    "xray-core"
    "sing-box"
    "xray-plugin"
    "naiveproxy"
    "trojan-plus"
    "tuic-client"
    "luci-app-passwall"
)

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_blue() { echo -e "${BLUE}[INFO]${NC} $1"; }

show_banner() {
    clear
    echo -e "${CYAN}=========================================="
    echo -e "            ${RED}XIDZs-WRT PROJECT${CYAN}"
    echo -e "                ${RED}XDEVTools${CYAN}"
    echo -e "       ${YELLOW}VERSION 2.6${NC} | ${RED}CREDIT : FIDZ${CYAN}"
    echo -e "      ${YELLOW}WARNING : KONEKSI WAJIB LANCAR${CYAN}"
    echo -e "       ${RED}SUPPORT v23.05.x | v24.10.x${CYAN}"
    echo -e "==========================================${NC}"
}

show_menu() {
    show_banner
    load_config
    
    echo ""
    if [ -n "$VEROP" ] && [ -n "$ARCH" ]; then
        echo "OpenWRT: $VEROP | Arsitektur: $ARCH"
        echo "Target: $ARCH_3"
        if [ "$OPKG_UPDATED" = true ]; then
            echo -e "${GREEN}Status: packages sudah diperbarui ✓${NC}"
        else
            echo -e "${YELLOW}Status: packages belum diperbarui${NC}"
        fi
    else
        echo -e "${CYAN}Mendukung Arch: x86_64|i386|armv6|armv7|aarch64${NC}"
    fi
    echo ""
    echo "TUNNEL:"
    echo "  1) OpenClash"
    echo "  2) PassWall"
    echo "  3) Nikki"
    echo "  4) InsomClash"
    echo "  5) Nikki + InsomClash"
    echo "  6) OpenClash + Nikki"
    echo "  7) OpenClash + InsomClash"
    echo "  8) OpenClash + PassWall"
    echo "  9) PassWall + Nikki"
    echo "  10) All Tunnel"
    echo ""
    echo "MIHOMO CORE:"
    echo "  11) OpenClash Core"
    echo "  12) Nikki Core"
    echo "  13) Insomclash Core"
    echo ""
    echo "TOOLS:"
    echo "  14) Bandix"
    echo "  15) Netmonitor"
    echo "  16) Modemdata"
    echo "  17) Webdroidx"
    echo "  18) Andromodem"
    echo "  19) Rakitanmanager Reborn"
    echo "  20) AdguardHome"
    echo "  21) All Tools"
    echo ""
    echo "CUSTOM:"
    echo "  22) Fix TTL"
    echo "  23) Add Custom Port"
    echo "  24) Usb Mode"
    echo "  25) Patch Openclash"
    echo ""
    echo "WIFI DEVICES:"
    echo "  26) Configurasi WIFI"
    echo ""
    echo "BOT MONITORING:"
    echo "  27) XidzBot"
    echo ""
    echo "TEMA OPENWRT:"
    echo "  28) Kumpulan Tema"
    echo ""
    echo "GAYA TEMA XIDZsWRT:"
    echo "  29) Style | Gaya"
    echo ""
    echo "UNINSTALL:"
    echo "  30) Tunnels & Tools"
    echo ""
    echo "  0) Keluar"
    echo ""
    echo -n "Pilih [0-29]: "
}

select_openwrt_version() {
    echo ""
    log_blue "Pilih versi OpenWRT:"
    echo ""
    echo "  1) 23.05.x"
    echo "  2) 24.10.x"
    echo ""
    echo -n "Pilih [1-2]: "
    read version_choice
    
    case $version_choice in
        1) VEROP="23.05.x" ;;
        2) VEROP="24.10.x" ;;
        *)
            log_warn "Pilihan salah, menggunakan versi 24.10.x"
            VEROP="24.10.x"
            ;;
    esac
    
    log_info "Versi OpenWRT: $VEROP"
}

select_architecture() {
    echo ""
    log_blue "Pilih arsitektur sistem:"
    echo ""
    echo "  1) x86_64"
    echo "  2) i386_pentium4"
    echo "  3) aarch64_cortex-a53"
    echo "  4) aarch64_cortex-a72"
    echo "  5) aarch64_cortex-a76"
    echo "  6) aarch64_generic"
    echo "  7) arm_cortex-a7_neon-vfpv4"
    echo "  8) arm_arm1176jzf-s_vfp"
    echo ""
    echo -n "Pilih [1-8]: "
    read arch_choice
    
    case $arch_choice in
        1)
            ARCH="x86_64"
            ARCH_1="amd64"
            ARCH_2="x86_64"
            ARCH_3="x86_64"
            ;;
        2)
            ARCH="i386"
            ARCH_1="386"
            ARCH_2="i386"
            ARCH_3="i386_pentium4"
            ;;
        3)
            ARCH="aarch64"
            ARCH_1="arm64"
            ARCH_2="aarch64"
            ARCH_3="aarch64_cortex-a53"
            ;;
        4)
            ARCH="aarch64"
            ARCH_1="arm64"
            ARCH_2="aarch64"
            ARCH_3="aarch64_cortex-a72"
            ;;
        5)
            ARCH="aarch64"
            ARCH_1="arm64"
            ARCH_2="aarch64"
            ARCH_3="aarch64_cortex-a76"
            ;;
        6)
            ARCH="aarch64"
            ARCH_1="arm64"
            ARCH_2="aarch64"
            ARCH_3="aarch64_generic"
            ;;
        7)
            ARCH="arm"
            ARCH_1="armv7"
            ARCH_2="arm"
            ARCH_3="arm_cortex-a7_neon-vfpv4"
            ;;
        8)
            ARCH="arm"
            ARCH_1="armv6"
            ARCH_2="arm"
            ARCH_3="arm_arm1176jzf-s_vfp"
            ;;
        *)
            log_error "Pilihan arsitektur tidak valid"
            exit 1
            ;;
    esac
    
    log_info "Konfigurasi arsitektur:"
    echo "  - ARCH: $ARCH"
    echo "  - Mihomo: $ARCH_1"
    echo "  - OpenWRT: $ARCH_3"
    
    save_config
}

auto_setup_config() {
    if ! has_config; then
        select_openwrt_version
        select_architecture
    fi
}

select_core_version() {
    echo ""
    log_blue "Pilih versi Mihomo Core:"
    echo ""
    echo "  1) Latest Release (Stabil)"
    echo "  2) Alpha Release (Pre-release)"
    echo "  3) Alpha Smart (Pre-release + Smart routing)"
    echo ""
    echo -n "Pilih [1-3]: "
    read core_choice
    
    case $core_choice in
        1) 
            CORE_VERSION_TYPE="latest"
            log_info "Menggunakan Latest Release"
            ;;
        2) 
            CORE_VERSION_TYPE="alpha"
            log_info "Menggunakan Alpha Release"
            ;;
        3) 
            CORE_VERSION_TYPE="alpha-smart"
            log_info "Menggunakan Alpha Smart Release"
            ;;
        *)
            log_warn "Pilihan salah, menggunakan Latest Release"
            CORE_VERSION_TYPE="latest"
            ;;
    esac
}

repair_opkg_database() {
    log_info "Memeriksa database OPKG..."
    
    if [ -f /usr/lib/opkg/status ]; then
        if [ "$(tail -c1 /usr/lib/opkg/status | wc -l)" -eq 0 ]; then
            log_warn "Memperbaiki file status"
            echo "" >> /usr/lib/opkg/status
        fi
        
        log_info "Membersihkan database rusak"
        sed -i '/^Package: $/d' /usr/lib/opkg/status 2>/dev/null
        sed -i '/^Version: $/d' /usr/lib/opkg/status 2>/dev/null
    fi
    
    if [ "$OPKG_UPDATED" = false ]; then
        log_info "Memperbarui database packages..."
        if opkg update >/dev/null 2>&1; then
            log_info "Database packages berhasil diperbarui"
            OPKG_UPDATED=true
        else
            log_warn "Gagal memperbarui database"
        fi
    fi
}

update_package_list_once() {
    if [ "$OPKG_UPDATED" = false ]; then
        log_info "Memperbarui database packages..."
        if opkg update >/dev/null 2>&1; then
            log_info "Database packages berhasil diperbarui"
            OPKG_UPDATED=true
        else
            log_warn "Gagal memperbarui database"
        fi
    fi
}

is_package_installed() {
    local pkg_name="$1"
    
    if opkg list-installed 2>/dev/null | grep -q "^$pkg_name "; then
        return 0
    fi
    
    local config_name=""
    local use_dir=false
    
    case "$pkg_name" in
        luci-app-openclash) config_name="openclash" ;;
        luci-app-passwall)  config_name="passwall" ;;
        nikki|luci-app-nikki) config_name="nikki" ;;
        insomclash|luci-app-insomclash) 
            config_name="insomclash"
            use_dir=true
            ;;
        bandix|luci-app-bandix) config_name="bandix" ;;
        luci-app-netmonitor) config_name="netmonitor" ;;
        modemdata|luci-app-modemdata) config_name="modemdata" ;;
        webdroidx) config_name="webdroidx" ;;
        andromodem|luci-app-andromodem) config_name="andromodem" ;;
        *) return 1 ;;
    esac
    
    if [ "$use_dir" = true ]; then
        if [ -d "/etc/$config_name" ] || [ -d "/usr/lib/lua/luci/controller/$config_name" ]; then
            return 0
        fi
    else
        if [ -f "/etc/config/$config_name" ] || [ -d "/usr/lib/lua/luci/controller/$config_name" ]; then
            return 0
        fi
    fi
    
    return 1
}

get_related_packages() {
    local main_pkg="$1"
    local related_pkgs=()
    
    case "$main_pkg" in
        luci-app-openclash)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ openclash ]] && [[ "$pkg" != "$main_pkg" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/openclash/{print $1}')
            ;;
        luci-app-passwall)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ passwall ]] && [[ "$pkg" != "$main_pkg" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/passwall/{print $1}')
            ;;
        nikki)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ ^nikki ]] && [[ "$pkg" != "nikki" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/^nikki/{print $1}')
            ;;
        luci-app-nikki)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ ^nikki ]] && [[ "$pkg" != "luci-app-nikki" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/^nikki/{print $1}')
            ;;
        insomclash)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ ^insomclash ]] && [[ "$pkg" != "insomclash" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/^insomclash/{print $1}')
            ;;
        luci-app-insomclash)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ ^insomclash ]] && [[ "$pkg" != "luci-app-insomclash" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/^insomclash/{print $1}')
            ;;
        bandix)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ ^bandix ]] && [[ "$pkg" != "bandix" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/^bandix/{print $1}')
            ;;
        luci-app-bandix)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ ^bandix ]] && [[ "$pkg" != "luci-app-bandix" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/^bandix/{print $1}')
            ;;
        luci-app-netmonitor)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ netmonitor ]] && [[ "$pkg" != "luci-app-netmonitor" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/netmonitor/{print $1}')
            ;;
        modemdata)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ modemdata ]] && [[ "$pkg" != "modemdata" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/modemdata/{print $1}')
            ;;
        luci-app-modemdata)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ modemdata ]] && [[ "$pkg" != "luci-app-modemdata" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/modemdata/{print $1}')
            ;;
        webdroidx)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ webdroidx ]] && [[ "$pkg" != "luci-app-webdroidx" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/webdroidx/{print $1}')
            ;;
        andromodem)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ andromodem ]] && [[ "$pkg" != "andromodem" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/andromodem/{print $1}')
            ;;
        luci-app-andromodem)
            related_pkgs+=("$main_pkg")
            while IFS= read -r pkg; do
                [[ "$pkg" =~ andromodem ]] && [[ "$pkg" != "luci-app-andromodem" ]] && related_pkgs+=("$pkg")
            done < <(opkg list-installed 2>/dev/null | awk '/andromodem/{print $1}')
            ;;
        
    esac
    
    printf '%s\n' "${related_pkgs[@]}" | sort -u
}

check_dependencies() {
    log_info "Memeriksa dependensi..."
    
    local deps=("curl" "wget" "gzip" "unzip" "tar")
    local missing_deps=()
    
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            missing_deps+=("$dep")
        fi
    done
    
    if [ ${#missing_deps[@]} -gt 0 ]; then
        log_warn "Dependensi kurang: ${missing_deps[*]}"
        
        log_info "Menginstall dependensi..."
        for dep in "${missing_deps[@]}"; do
            opkg install "$dep" >/dev/null 2>&1
        done
        
        log_info "Dependensi berhasil diinstall"
    else
        log_info "Semua dependensi sudah terpenuhi"
    fi
}

install_package_simple() {
    local pkg_file="$1"
    local pkg_name=$(basename "$pkg_file")
    
    log_info "Menginstall: $pkg_name"
    
    if [[ "$pkg_name" == "insomclash"*.ipk ]]; then
        if opkg install --force-space "$pkg_file" 2>/dev/null; then
            log_info "✓ Berhasil install: $pkg_name ⍟"
            return 0
        else
            log_error "✗ Gagal install: $pkg_name"
            return 1
        fi
    else
        if opkg install "$pkg_file" 2>/dev/null; then
            log_info "✓ Berhasil install: $pkg_name"
            return 0
        else
            log_error "✗ Gagal install: $pkg_name"
            return 1
        fi
    fi
}

uninstall_package_with_fallback() {
    local pkg_name="$1"
    
    log_info "Menghapus: $pkg_name"
    
    if opkg remove "$pkg_name" 2>/dev/null; then
        log_info "✓ Berhasil hapus: $pkg_name"
        return 0
    else
        log_warn "Hapus normal gagal, coba force mode"
        if opkg remove --force-depends "$pkg_name" 2>/dev/null; then
            log_info "✓ Berhasil hapus dengan force: $pkg_name"
            return 0
        else
            log_error "✗ Gagal hapus: $pkg_name"
            return 1
        fi
    fi
}

download_file() {
    local url="$1"
    local output="$2"
    
    if [ -z "$url" ]; then
        log_error "URL download kosong"
        return 1
    fi
    
    log_info "Mendownload: $(basename $output)"
    
    if command -v wget &> /dev/null; then
        wget --no-check-certificate -q --show-progress -O "$output" "$url" 2>&1
    else
        curl -L --insecure -# -o "$output" "$url" 2>&1
    fi
    
    if [ $? -eq 0 ] && [ -f "$output" ] && [ -s "$output" ]; then
        log_info "Download selesai: $(basename $output) ($(du -h $output | cut -f1))"
        return 0
    else
        log_error "Download gagal: $(basename $output)"
        [ -f "$output" ] && rm -f "$output"
        return 1
    fi
}

download_mihomo_core() {
    local target_path="$1"
    local app_name="$2"
    
    log_blue "=========================================="
    log_blue "    DOWNLOAD MIHOMO CORE - $app_name"
    log_blue "=========================================="
    
    mkdir -p "$(dirname "$target_path")"
    
    case "${ARCH_3}" in
        "x86_64")
            meta_file="mihomo-linux-amd64-compatible"
            ;;
        "i386_pentium4")
            meta_file="mihomo-linux-386"
            ;;
        "arm_cortex-a7_neon-vfpv4")
            meta_file="mihomo-linux-armv7"
            ;;
        "arm_arm1176jzf-s_vfp")
            meta_file="mihomo-linux-armv6"
            ;;
        "aarch64"*|"arm64")
            meta_file="mihomo-linux-arm64"
            ;;
        *)
            log_error "Arsitektur tidak didukung: ${ARCH_3}"
            return 1
            ;;
    esac
    
    log_info "Target: $target_path"
    log_info "Arsitektur: ${ARCH_3} → $meta_file"
    log_info "Versi: ${CORE_VERSION_TYPE^^}"
    
    if [ -f "$target_path" ]; then
        log_info "Menghapus core lama"
        rm -f "$target_path"
    fi
    
    local mihomo_core_url=""
    local version_info=""
    
    if [ "$CORE_VERSION_TYPE" = "alpha" ]; then
        log_info "Mengambil versi Alpha..."
        mihomo_core_url=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/Prerelease-Alpha" | grep "browser_download_url" | grep -oE "https.*${meta_file}-alpha-[a-zA-Z0-9]+\.gz" | head -n 1)
        version_info=$(echo "$mihomo_core_url" | grep -oE "alpha-[a-zA-Z0-9]+")
    elif [ "$CORE_VERSION_TYPE" = "alpha-smart" ]; then
        log_info "Mengambil versi Alpha Smart..."
        mihomo_core_url=$(curl -s "https://api.github.com/repos/vernesong/mihomo/releases/tags/Prerelease-Alpha" | grep "browser_download_url" | grep -oE "https.*${meta_file}-alpha-smart-[a-zA-Z0-9]+\.gz" | head -n 1)
        version_info=$(echo "$mihomo_core_url" | grep -oE "alpha-smart-[a-zA-Z0-9]+")
    else
        log_info "Mengambil versi Latest..."
        mihomo_core_url=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | grep "browser_download_url" | grep -oE "https.*${meta_file}-v[0-9]+\.[0-9]+\.[0-9]+\.gz" | head -n 1)
        version_info=$(echo "$mihomo_core_url" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+")
    fi
    
    if [ -z "$mihomo_core_url" ]; then
        log_error "Gagal mendapatkan URL download"
        return 1
    fi
    
    log_info "Versi Mihomo: $version_info"
    
    download_file "$mihomo_core_url" "/tmp/mihomo_core.gz" || return 1
    
    log_info "Mengekstrak file..."
    if gzip -d /tmp/mihomo_core.gz 2>/dev/null; then
        log_info "File berhasil diekstrak"
    else
        log_error "Gagal ekstrak file"
        return 1
    fi
    
    if [ ! -f /tmp/mihomo_core ]; then
        log_error "File ekstrak tidak ditemukan"
        return 1
    fi
    
    log_info "Memindahkan core ke: $target_path"
    mv /tmp/mihomo_core "$target_path"
    
    log_info "Setting permission..."
    chmod 755 "$target_path"
    
    if [ -f "$target_path" ] && [ -x "$target_path" ]; then
        local file_size=$(du -h "$target_path" | cut -f1)
        log_info "✓ Mihomo Core berhasil diinstall"
        log_info "  - Lokasi: $target_path"
        log_info "  - Ukuran: $file_size"
        log_info "  - Versi: $version_info (${CORE_VERSION_TYPE^^})"
        return 0
    else
        log_error "✗ Gagal install Mihomo Core"
        return 1
    fi
}

download_openclash_core() {
    show_banner
    echo ""
    log_blue "=========================================="
    log_blue "      DOWNLOAD OPENCLASH CORE"
    log_blue "=========================================="
    
    select_architecture
    select_core_version
    
    echo ""
    download_mihomo_core "/etc/openclash/core/clash_meta" "OPENCLASH"
}

download_nikki_core() {
    show_banner
    echo ""
    log_blue "=========================================="
    log_blue "        DOWNLOAD NIKKI CORE"
    log_blue "=========================================="
    
    select_architecture
    select_core_version
    
    echo ""
    download_mihomo_core "/usr/bin/mihomo" "NIKKI"
}

download_insomclash_core() {
    show_banner
    echo ""
    log_blue "=========================================="
    log_blue "        DOWNLOAD INSOMCLASH CORE"
    log_blue "=========================================="
    
    select_architecture
    select_core_version
    
    echo ""
    download_mihomo_core "/usr/bin/mihomo" "INSOMCLASH"
}

restart_services() {
    echo ""
    log_blue "=========================================="
    log_blue "          INSTALLATION SERVICES"
    log_blue "=========================================="
    
    log_info "Restarting uhttpd service..."
    if /etc/init.d/uhttpd restart 2>/dev/null; then
        log_info "uhttpd restarted successfully"
    else
        log_warn "Failed to restart uhttpd"
    fi
    
    if [ -f /sbin/free.sh ]; then
        log_info "Running Clean Cache..."
        if bash /sbin/free.sh 2>/dev/null; then
            log_info "File Cache Telah Di Bersihkan"
        else
            log_warn "File Cache Gagal Di Bersihkan"
        fi
    else
        log_warn "File Cache not found, skipping..."
    fi
    
    echo ""
}

select_openclash_repo() {
    echo ""
    log_blue "Select OpenClash repository:"
    echo ""
    echo "  1) vernesong (Official)"
    echo "  2) de-quenx (Modified)"
    echo ""
    echo -n "Enter choice [1-2]: "
    read repo_choice
    
    openclash_file_ipk="luci-app-openclash"
    
    case $repo_choice in
        1)
            log_info "Repository: vernesong (Official)"
            OPENCLASH_REPO="https://api.github.com/repos/vernesong/OpenClash/releases"
            ;;
        2)
            log_info "Repository: de-quenx (Modified)"
            OPENCLASH_REPO="https://api.github.com/repos/de-quenx/OpenClash-x/releases"
            ;;
        *)
            log_warn "Invalid choice, using Official"
            OPENCLASH_REPO="https://api.github.com/repos/vernesong/OpenClash/releases"
            ;;
    esac
}

select_install_type() {
    echo ""
    log_blue "Select installation type:"
    echo ""
    echo "  1) Full Install"
    echo "  2) IPK Only"
    echo ""
    echo -e "${YELLOW}Auto-pilih 'IPK Only' dalam 5 detik...${NC}"
    echo ""
    echo -n "Enter choice [1-2]: "
    
    local INSTALL_TYPE="ipk"
    if read -t 5 install_type_choice; then
        echo ""
        case $install_type_choice in
            1)
                log_info "Installation type: Full Install"
                INSTALL_TYPE="full"
                ;;
            2)
                log_info "Installation type: IPK Only"
                INSTALL_TYPE="ipk"
                ;;
            *)
                log_warn "Invalid choice, using IPK Only"
                INSTALL_TYPE="ipk"
                ;;
        esac
    else
        echo ""
        log_info "Auto-pilih: IPK Only"
        INSTALL_TYPE="ipk"
    fi
}

install_openclash() {
    log_blue "=========================================="
    log_blue "        INSTALLING OPENCLASH"
    log_blue "=========================================="
    
    select_openclash_repo
    select_install_type
    
    mkdir -p /tmp/openclash /etc/openclash/core
    
    if [ "$INSTALL_TYPE" = "full" ]; then
        log_info "Installing dependencies..."
        update_package_list_once
        
        local dependencies="coreutils-nohup ipset ip-full libcap libcap-bin ruby ruby-yaml kmod-tun kmod-inet-diag kmod-nft-tproxy"
        
        for package in $dependencies; do
            log_info "Installing $package..."
            if ! opkg install "$package" 2>/dev/null; then
                log_warn "Failed to install $package, continuing..."
            fi
        done
    fi
    
    log_info "Fetching OpenClash IPK URL..."
    
    if [[ "$OPENCLASH_REPO" == *"vernesong"* ]]; then
        log_info "Searching in Official repository (all releases)..."
        openclash_ipk_url=$(curl -s "https://api.github.com/repos/vernesong/OpenClash/releases" | grep "browser_download_url" | grep -oE "https.*${openclash_file_ipk}.*.ipk" | head -n 1)
    else
        log_info "Searching in Modified repository..."
        openclash_ipk_url=$(curl -s "$OPENCLASH_REPO" | grep "browser_download_url" | grep -oE "https.*${openclash_file_ipk}.*.ipk" | head -n 1)
    fi
    
    if [ -z "$openclash_ipk_url" ]; then
        log_warn "IPK not found, trying alternative repository..."
        if [[ "$OPENCLASH_REPO" == *"vernesong"* ]]; then
            openclash_ipk_url=$(curl -s "https://api.github.com/repos/de-quenx/OpenClash-x/releases" | grep "browser_download_url" | grep -oE "https.*${openclash_file_ipk}.*.ipk" | head -n 1)
        else
            openclash_ipk_url=$(curl -s "https://api.github.com/repos/vernesong/OpenClash/releases" | grep "browser_download_url" | grep -oE "https.*${openclash_file_ipk}.*.ipk" | head -n 1)
        fi
    fi
    
    if [ -z "$openclash_ipk_url" ]; then
        log_error "Failed to get OpenClash IPK URL from both repositories"
        log_error "Please check your internet connection or try again later"
        return 1
    fi
    
    download_file "$openclash_ipk_url" "/tmp/openclash/openclash.ipk" || return 1
    
    echo ""
    log_blue "Install Mihomo Core untuk OpenClash?"
    echo ""
    echo "  1) Ya - Download dan install core"
    echo "  2) Tidak - Skip install core"
    echo ""
    echo -e "${YELLOW}Auto-pilih 'Ya' dalam 5 detik...${NC}"
    echo ""
    echo -n "Pilih [1-2]: "
    
    local install_core=true
    if read -t 5 core_choice; then
        echo ""
        if [ "$core_choice" = "2" ]; then
            install_core=false
            log_info "Skip install Mihomo Core"
        else
            log_info "Install Mihomo Core"
        fi
    else
        echo ""
        log_info "Auto-pilih: Install Mihomo Core"
    fi
    
    if [ "$install_core" = true ]; then
        log_info "Fetching Mihomo Core..."
        if [[ "${ARCH_3}" == "x86_64" ]]; then
            meta_file="mihomo-linux-${ARCH_1}-compatible"
        else
            meta_file="mihomo-linux-${ARCH_1}"
        fi
        
        local mihomo_core_url=""
        local version_info=""
        
        if [ "$CORE_VERSION_TYPE" = "alpha" ]; then
            mihomo_core_url=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/Prerelease-Alpha" | grep "browser_download_url" | grep -oE "https.*${meta_file}-alpha-[a-zA-Z0-9]+\.gz" | head -n 1)
            version_info=$(echo "$mihomo_core_url" | grep -oE "alpha-[a-zA-Z0-9]+")
        elif [ "$CORE_VERSION_TYPE" = "alpha-smart" ]; then
            mihomo_core_url=$(curl -s "https://api.github.com/repos/vernesong/mihomo/releases/tags/Prerelease-Alpha" | grep "browser_download_url" | grep -oE "https.*${meta_file}-alpha-smart-[a-zA-Z0-9]+\.gz" | head -n 1)
            version_info=$(echo "$mihomo_core_url" | grep -oE "alpha-smart-[a-zA-Z0-9]+")
        else
            mihomo_core_url=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | grep "browser_download_url" | grep -oE "https.*${meta_file}-v[0-9]+\.[0-9]+\.[0-9]+\.gz" | head -n 1)
            version_info=$(echo "$mihomo_core_url" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+")
        fi
        
        if [ -z "$mihomo_core_url" ]; then
            log_error "Failed to get Mihomo Core for ${meta_file}"
            log_warn "Lanjutkan install tanpa core"
        else
            log_info "Mihomo Core version: $version_info (${CORE_VERSION_TYPE^^})"
            
            if download_file "$mihomo_core_url" "/tmp/openclash/clash_meta.gz"; then
                log_info "Extracting Mihomo Core..."
                if gzip -d /tmp/openclash/clash_meta.gz 2>/dev/null; then
                    mv /tmp/openclash/clash_meta /etc/openclash/core/
                    chmod +x /etc/openclash/core/clash_meta
                    log_info "Mihomo Core installed with executable permission"
                else
                    log_warn "Gagal ekstrak core, lanjutkan tanpa core"
                fi
            else
                log_warn "Gagal download core, lanjutkan tanpa core"
            fi
        fi
    fi
    
    echo ""
    if [ "$INSTALL_TYPE" = "ipk" ]; then
        update_package_list_once
    fi
    echo ""
    
    log_info "Installing OpenClash IPK..."
    if install_package_simple "/tmp/openclash/openclash.ipk"; then
        log_info "OpenClash installed successfully"
        rm -rf /tmp/openclash
        INSTALL_SUCCESS=true
        return 0
    else
        log_error "Failed to install OpenClash"
        return 1
    fi
}

filter_passwall_packages() {
    local source_dir="$1"
    local filtered_dir="$2"
    
    mkdir -p "$filtered_dir"
    
    log_info "Filtering PassWall packages..."
    log_info "Required packages: ${PASSWALL_PACKAGES[*]}"
    echo ""
    
    local found_packages=()
    local missing_packages=()
    
    for required_pkg in "${PASSWALL_PACKAGES[@]}"; do
        local found=false
        
        for ipk_file in "$source_dir"/*.ipk; do
            if [ -f "$ipk_file" ]; then
                local filename=$(basename "$ipk_file")
                
                if [[ "$filename" == "${required_pkg}_"* ]] || [[ "$filename" == "${required_pkg}.ipk" ]] || [[ "$filename" == "${required_pkg}-"* ]]; then
                    cp "$ipk_file" "$filtered_dir/"
                    found_packages+=("$filename")
                    found=true
                    log_info "✓ Found: $filename"
                    break
                fi
            fi
        done
        
        if [ "$found" = false ]; then
            missing_packages+=("$required_pkg")
            log_warn "✗ Missing: $required_pkg"
        fi
    done
    
    echo ""
    log_info "Filter summary:"
    log_info "  - Found: ${#found_packages[@]} packages"
    log_info "  - Missing: ${#missing_packages[@]} packages"
    
    if [ ${#missing_packages[@]} -gt 0 ]; then
        log_warn "Missing packages will be skipped: ${missing_packages[*]}"
    fi
    
    return 0
}

download_latest_luci_passwall() {
    local output_dir="$1"
    
    log_info "Downloading latest luci-app-passwall from GitHub..."
    
    local latest_release_url=$(curl -s "https://api.github.com/repos/xiaorouji/openwrt-passwall/releases/latest" | grep "browser_download_url" | grep "luci-app-passwall.*_all\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$latest_release_url" ]; then
        log_warn "Latest release not found, trying manual pattern..."
        local tag_name=$(curl -s "https://api.github.com/repos/xiaorouji/openwrt-passwall/releases/latest" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
        
        if [ -n "$tag_name" ]; then
            latest_release_url="https://github.com/xiaorouji/openwrt-passwall/releases/download/${tag_name}/luci-app-passwall_${tag_name}_all.ipk"
            log_info "Trying constructed URL for tag: $tag_name"
        else
            log_warn "Could not determine latest tag, using fallback URL..."
            latest_release_url="https://github.com/xiaorouji/openwrt-passwall/releases/download/25.11.15-1/luci-app-passwall_25.11.15-r1_all.ipk"
        fi
    fi
    
    local version_info=$(echo "$latest_release_url" | grep -oE "luci-app-passwall_[^/]*\.ipk" | sed 's/luci-app-passwall_//g' | sed 's/\.ipk//g')
    log_info "Version: $version_info"
    
    if download_file "$latest_release_url" "${output_dir}/luci-app-passwall.ipk"; then
        log_info "✓ Latest luci-app-passwall downloaded successfully"
        return 0
    else
        log_error "✗ Failed to download luci-app-passwall"
        return 1
    fi
}

install_passwall() {
    log_blue "=========================================="
    log_blue "        INSTALLING PASSWALL"
    log_blue "=========================================="
    
    mkdir -p /tmp/passwall /tmp/passwall_filtered
    
    log_info "Required PassWall packages:"
    printf '  - %s\n' "${PASSWALL_PACKAGES[@]}"
    echo ""
    
    log_info "Downloading PassWall dependencies from GitHub..."
    passwall_packages_url=$(curl -s "https://api.github.com/repos/xiaorouji/openwrt-passwall/releases" | grep "browser_download_url" | grep -oE "https.*passwall_packages_ipk_${ARCH_3}.*\.zip" | head -n 1)
    
    if [ -z "$passwall_packages_url" ] && [[ "$ARCH_3" == "aarch64_cortex"* ]]; then
        log_warn "Trying with aarch64_generic..."
        passwall_packages_url=$(curl -s "https://api.github.com/repos/xiaorouji/openwrt-passwall/releases" | grep "browser_download_url" | grep -oE "https.*passwall_packages_ipk_aarch64_generic.*\.zip" | head -n 1)
    fi
    
    if [ -z "$passwall_packages_url" ] && [[ "$ARCH_3" == "i386_pentium4" ]]; then
        log_warn "i386_pentium4 not found, trying with x86_64..."
        passwall_packages_url=$(curl -s "https://api.github.com/repos/xiaorouji/openwrt-passwall/releases" | grep "browser_download_url" | grep -oE "https.*passwall_packages_ipk_x86_64.*\.zip" | head -n 1)
    fi
    
    if [ -z "$passwall_packages_url" ]; then
        log_error "Failed to get PassWall packages from GitHub"
        return 1
    fi
    
    download_file "$passwall_packages_url" "/tmp/passwall/packages.zip" || return 1
    
    log_info "Extracting PassWall packages..."
    unzip -q /tmp/passwall/packages.zip -d /tmp/passwall/
    rm -f /tmp/passwall/packages.zip
    
    echo ""
    log_info "=========================================="
    log_info "    DOWNLOADING LATEST LUCI-APP-PASSWALL"
    log_info "=========================================="
    download_latest_luci_passwall "/tmp/passwall" || {
        log_warn "Failed to download latest luci-app-passwall, continuing with filtering..."
    }
    
    echo ""
    log_info "=========================================="
    log_info "    FILTERING REQUIRED PACKAGES ONLY"
    log_info "=========================================="
    
    filter_passwall_packages "/tmp/passwall" "/tmp/passwall_filtered"
    
    echo ""
    log_info "Packages selected for installation:"
    ls -lh /tmp/passwall_filtered/*.ipk 2>/dev/null
    
    if [ $(ls -1 /tmp/passwall_filtered/*.ipk 2>/dev/null | wc -l) -eq 0 ]; then
        log_error "No required packages found after filtering!"
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_info "Installing filtered PassWall packages..."
    
    local packages_installed=0
    local packages_failed=0
    
    log_info "Installing dependencies first..."
    for ipk in /tmp/passwall_filtered/*.ipk; do
        if [ -f "$ipk" ]; then
            pkg_name=$(basename "$ipk")
            
            if [[ "$pkg_name" == luci-app-passwall* ]]; then
                continue
            fi
            
            if install_package_simple "$ipk"; then
                ((packages_installed++))
            else
                ((packages_failed++))
            fi
        fi
    done
    
    echo ""
    log_blue "=========================================="
    log_blue "     INSTALLING LUCI-APP-PASSWALL "
    log_blue "=========================================="
    
    PASSWALL_IPK=$(find /tmp/passwall_filtered -name "luci-app-passwall*.ipk" | head -n 1)
    
    if [ -f "$PASSWALL_IPK" ]; then
        local luci_version=$(basename "$PASSWALL_IPK" | sed 's/luci-app-passwall//g' | sed 's/\.ipk//g' | sed 's/^_//g')
        log_info "Installing luci-app-passwall version: $luci_version"
        
        if install_package_simple "$PASSWALL_IPK"; then
            ((packages_installed++))
            log_info "✓ luci-app-passwall installed successfully"
        else
            ((packages_failed++))
            log_error "✗ Failed to install luci-app-passwall"
        fi
    else
        log_error "luci-app-passwall.ipk not found in filtered packages!"
        ((packages_failed++))
    fi
    
    echo ""
    log_info "PassWall installation summary:"
    log_info "  - Successfully installed: $packages_installed packages"
    if [ $packages_failed -gt 0 ]; then
        log_warn "  - Failed to install: $packages_failed packages"
    fi
    
    if [ $packages_installed -gt 0 ]; then
        log_info "PassWall installation completed with $packages_installed packages"
        rm -rf /tmp/passwall /tmp/passwall_filtered
        INSTALL_SUCCESS=true
        return 0
    else
        log_error "PassWall installation failed - no packages installed"
        return 1
    fi
}

select_nikki_repo() {
    echo ""
    log_blue "Pilih repository Nikki:"
    echo ""
    echo "  1) nikkinikki-org (Official)"
    echo "  2) de-quenx (Modified)"
    echo "  3) syntax-xidz (Modified)"
    echo "  4) Yogxx (Modified)"
    echo ""
    echo -n "Pilih [1-4]: "
    read repo_choice
    
    case $repo_choice in
        1)
            log_info "Repository: nikkinikki-org (Official)"
            NIKKI_REPO="https://api.github.com/repos/nikkinikki-org/OpenWrt-nikki/releases"
            ;;
        2)
            log_info "Repository: de-quenx (Modified)"
            NIKKI_REPO="https://api.github.com/repos/de-quenx/nikki-x/releases"
            ;;
        3)
            log_info "Repository: syntax-xidz (Modified)"
            NIKKI_REPO="https://api.github.com/repos/syntax-xidz/nikki-x/releases"
            ;;
        4)
            log_info "Repository: Yogxx (Modified)"
            NIKKI_REPO="https://api.github.com/repos/Yogxx/OpenWrt-nikkiku/releases"
            ;;
        *)
            log_warn "Pilihan salah, menggunakan Official"
            NIKKI_REPO="https://api.github.com/repos/nikkinikki-org/OpenWrt-nikki/releases"
            ;;
    esac
}

install_nikki() {
    log_blue "=========================================="
    log_blue "             INSTALL NIKKI"
    log_blue "=========================================="
    echo ""
    
    select_nikki_repo
    
    echo ""
    log_info "Mengambil packages Nikki..."
    
    mkdir -p /tmp/nikki
    
    local nikki_url=""
    
    if [[ "$NIKKI_REPO" == *"nikkinikki-org"* ]]; then
        log_info "Menggunakan repository Official"
        nikki_url=$(curl -s "$NIKKI_REPO/latest" | grep "browser_download_url" | grep -E "nikki.*${ARCH_3}.*\.(tar\.gz|zip)" | head -n 1 | cut -d '"' -f 4)
        
        if [ -z "$nikki_url" ] && [[ "$ARCH_3" == "aarch64_cortex"* ]]; then
            log_warn "packages tidak ada, coba generic ARM64"
            nikki_url=$(curl -s "$NIKKI_REPO/latest" | grep "browser_download_url" | grep -E "nikki.*aarch64_generic.*\.(tar\.gz|zip)" | head -n 1 | cut -d '"' -f 4)
        fi
    else
        log_info "Menggunakan repository Modified"
        nikki_url=$(curl -s "$NIKKI_REPO/latest" | grep "browser_download_url" | grep -E "nikki.*${ARCH_3}.*\.(tar\.gz|zip)" | head -n 1 | cut -d '"' -f 4)
        
        if [ -z "$nikki_url" ] && [[ "$ARCH_3" == "aarch64_cortex"* ]]; then
            log_warn "packages tidak ada, coba generic ARM64"
            nikki_url=$(curl -s "$NIKKI_REPO/latest" | grep "browser_download_url" | grep -E "nikki.*aarch64_generic.*\.(tar\.gz|zip)" | head -n 1 | cut -d '"' -f 4)
        fi
    fi
    
    if [ -z "$nikki_url" ]; then
        log_error "Gagal mendapatkan URL untuk: $ARCH_3"
        return 1
    fi
    
    if [[ "$nikki_url" == *.tar.gz ]]; then
        archive_file="nikki.tar.gz"
        extract_cmd="tar -xzf"
    elif [[ "$nikki_url" == *.zip ]]; then
        archive_file="nikki.zip"
        extract_cmd="unzip -q"
    else
        log_error "Format file tidak didukung"
        return 1
    fi
    
    if ! download_file "$nikki_url" "/tmp/nikki/$archive_file"; then
        log_error "Gagal download Nikki"
        return 1
    fi
    
    log_info "Ekstrak packages..."
    cd /tmp/nikki
    if ! $extract_cmd "$archive_file" 2>/dev/null; then
        log_error "Gagal ekstrak file"
        cd - > /dev/null
        return 1
    fi
    rm -f "$archive_file"
    cd - > /dev/null
    
    echo ""
    log_info "Memulai instalasi Nikki..."
    
    local packages_installed=0
    local packages_failed=0
    
    log_blue "=========================================="
    log_blue "            INSTALL NIKKI"
    log_blue "=========================================="
    
    NIKKI_CORE_IPK=$(find /tmp/nikki -name "nikki_*.ipk" | grep -v "luci-app-nikki" | head -n 1)
    
    if [ -f "$NIKKI_CORE_IPK" ]; then
        local core_version=$(basename "$NIKKI_CORE_IPK" | sed 's/nikki_//g' | sed 's/\.ipk//g' | sed "s/_${ARCH_3}//g")
        log_info "Install Nikki core versi: $core_version"
        
        if install_package_simple "$NIKKI_CORE_IPK"; then
            ((packages_installed++))
            log_info "✓ Nikki core berhasil diinstall"
            
            if [ -f "/usr/bin/mihomo" ]; then
                chmod 755 /usr/bin/mihomo
                local mihomo_size=$(du -h /usr/bin/mihomo | cut -f1)
                log_info "  - Mihomo: /usr/bin/mihomo ($mihomo_size)"
            else
                log_warn "  - Mihomo tidak ditemukan"
            fi
        else
            ((packages_failed++))
            log_error "✗ Gagal install Nikki core"
        fi
    else
        log_warn "packages Nikki core tidak ditemukan"
        ((packages_failed++))
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "        INSTALL LUCI-APP-NIKKI"
    log_blue "=========================================="
    
    NIKKI_IPK=$(find /tmp/nikki -name "luci-app-nikki*.ipk" | head -n 1)
    
    if [ -f "$NIKKI_IPK" ]; then
        local luci_version=$(basename "$NIKKI_IPK" | sed 's/luci-app-nikki//g' | sed 's/\.ipk//g')
        log_info "Install LuCI versi: $luci_version"
        
        if install_package_simple "$NIKKI_IPK"; then
            ((packages_installed++))
            log_info "✓ LuCI Nikki berhasil diinstall"
        else
            ((packages_failed++))
            log_error "✗ Gagal install LuCI Nikki"
        fi
    else
        log_warn "packages LuCI Nikki tidak ditemukan"
        ((packages_failed++))
    fi
    
    echo ""
    log_info "Hasil instalasi:"
    log_info "  - Berhasil: $packages_installed packages"
    if [ $packages_failed -gt 0 ]; then
        log_warn "  - Gagal: $packages_failed packages"
    fi
    
    rm -rf /tmp/nikki
    
    if [ $packages_installed -gt 0 ]; then
        log_info "Nikki berhasil diinstall"
        return 0
    else
        log_error "Gagal install Nikki"
        return 1
    fi
}

install_insomclash() {
    log_blue "=========================================="
    log_blue "         INSTALL INSOMCLASH"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/insomclash
    
    log_info "Mengambil versi latest Insomclash dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/bobbyunknown/FusionTunX/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local arch_suffix=""
    case "${ARCH_3}" in
        "x86_64")
            arch_suffix="x86_64"
            ;;
        "aarch64"*)
            arch_suffix="aarch64_generic"
            ;;
        *)
            log_error "Arsitektur tidak didukung untuk InsomClash Tunnel: ${ARCH_3}"
            log_warn "InsomClash hanya support x86_64 dan aarch64"
            return 1
            ;;
    esac
    
    log_info "Arsitektur target: ${ARCH_3} → ${arch_suffix}"
    
    local insomclash_core_url=$(echo "$latest_release" | grep "browser_download_url" | grep "/insomclash_" | grep "${arch_suffix}\.ipk" | head -n 1 | cut -d '"' -f 4)
    local insomclash_luci_url=$(echo "$latest_release" | grep "browser_download_url" | grep "/luci-app-insomclash_" | grep "\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$insomclash_core_url" ]; then
        log_error "URL InsomClash core tidak ditemukan untuk arsitektur: ${arch_suffix}"
        return 1
    fi
    
    if [ -z "$insomclash_luci_url" ]; then
        log_error "URL LuCI InsomClash tidak ditemukan"
        return 1
    fi
    
    local packages_installed=0
    local packages_failed=0
    
    log_blue "=========================================="
    log_blue "        DOWNLOAD INSOMCLASH"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$insomclash_core_url")"
    
    if ! download_file "$insomclash_core_url" "/tmp/insomclash/insomclash.ipk"; then
        log_error "Gagal download InsomClash core"
        rm -rf /tmp/insomclash
        return 1
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "       DOWNLOAD LUCI-APP-INSOMCLASH"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$insomclash_luci_url")"
    
    if ! download_file "$insomclash_luci_url" "/tmp/insomclash/luci-app-insomclash.ipk"; then
        log_error "Gagal download LuCI InsomClash"
        rm -rf /tmp/insomclash
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "          INSTALL INSOMCLASH"
    log_blue "=========================================="
    
    log_info "Cek file mihomo core..."
    if [ -f "/usr/bin/mihomo" ]; then
        log_warn "Ditemukan mihomo core, menghapus untuk menghindari konflik..."
        rm -f /usr/bin/mihomo
        log_info "✓ mihomo core telah dihapus"
    else
        log_info "✓ mihomo core tidak ada, lanjutkan install"
    fi
    
    log_info "Installing InsomClash core $version (dependency)..."
    
    if install_package_simple "/tmp/insomclash/insomclash.ipk"; then
        ((packages_installed++))
        log_info "✓ InsomClash core $version berhasil diinstall"
    else
        ((packages_failed++))
        log_error "✗ Gagal install InsomClash core"
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "      INSTALL LUCI-APP-INSOMCLASH"
    log_blue "=========================================="
    
    log_info "Installing LuCI InsomClash $version..."
    
    if install_package_simple "/tmp/insomclash/luci-app-insomclash.ipk"; then
        ((packages_installed++))
        log_info "✓ LuCI InsomClash $version berhasil diinstall"
    else
        ((packages_failed++))
        log_error "✗ Gagal install LuCI InsomClash"
    fi
    
    echo ""
    log_info "Hasil instalasi InsomClash:"
    log_info "  - Berhasil: $packages_installed packages"
    log_info "  - Version: $version"
    if [ $packages_failed -gt 0 ]; then
        log_warn "  - Gagal: $packages_failed packages"
    fi
    
    rm -rf /tmp/insomclash
    
    if [ $packages_installed -ge 2 ]; then
        log_info "InsomClash berhasil diinstall lengkap (core + luci)"
        return 0
    elif [ $packages_installed -eq 1 ]; then
        log_warn "InsomClash terinstall sebagian (hanya core)"
        return 1
    else
        log_error "Gagal install InsomClash"
        return 1
    fi
}

install_bandix() {
    log_blue "=========================================="
    log_blue "           INSTALL BANDIX"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/bandix
    
    log_info "Mengambil versi latest Bandix Tools dari GitHub..."
    
    local latest_core_release=$(curl -s "https://api.github.com/repos/timsaya/openwrt-bandix/releases/latest")
    local latest_luci_release=$(curl -s "https://api.github.com/repos/timsaya/luci-app-bandix/releases/latest")
    
    if [ -z "$latest_core_release" ] || [ -z "$latest_luci_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local core_version=$(echo "$latest_core_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    local luci_version=$(echo "$latest_luci_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan:"
    log_info "  - Bandix Tools Core: $core_version"
    log_info "  - LuCI Bandix Tools: $luci_version"
    
    local arch_suffix=""
    case "${ARCH_3}" in
        "x86_64")
            arch_suffix="x86_64"
            ;;
        "aarch64"*)
            arch_suffix="aarch64_generic"
            ;;
        *)
            log_error "Arsitektur tidak didukung untuk Bandix Tools: ${ARCH_3}"
            log_warn "Bandix Tools hanya support x86_64 dan aarch64"
            return 1
            ;;
    esac
    
    local bandix_core_url=$(echo "$latest_core_release" | grep "browser_download_url" | grep "${arch_suffix}\.ipk" | head -n 1 | cut -d '"' -f 4)
    local bandix_luci_url=$(echo "$latest_luci_release" | grep "browser_download_url" | grep "_all.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$bandix_core_url" ]; then
        log_error "URL Bandix Tools core tidak ditemukan untuk arsitektur: ${arch_suffix}"
        return 1
    fi
    
    if [ -z "$bandix_luci_url" ]; then
        log_error "URL LuCI Bandix Tools tidak ditemukan"
        return 1
    fi
    
    log_info "Arsitektur target: ${ARCH_3} → ${arch_suffix}"
    
    local packages_installed=0
    local packages_failed=0
    
    log_blue "=========================================="
    log_blue "           DOWNLOAD BANDIX"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$bandix_core_url")"
    
    if ! download_file "$bandix_core_url" "/tmp/bandix/bandix-core.ipk"; then
        log_error "Gagal download Bandix Tools core"
        rm -rf /tmp/bandix
        return 1
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "        DOWNLOAD LUCI-APP-BANDIX"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$bandix_luci_url")"
    
    if ! download_file "$bandix_luci_url" "/tmp/bandix/luci-app-bandix.ipk"; then
        log_error "Gagal download LuCI Bandix Tools"
        rm -rf /tmp/bandix
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "            INSTALL BANDIX"
    log_blue "=========================================="
    
    log_info "Installing Bandix Tools core $core_version (dependency)..."
    
    if install_package_simple "/tmp/bandix/bandix-core.ipk"; then
        ((packages_installed++))
        log_info "✓ Bandix Tools core $core_version berhasil diinstall"
    else
        ((packages_failed++))
        log_error "✗ Gagal install Bandix Tools core"
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "        INSTALL LUCI-APP-BANDIX"
    log_blue "=========================================="
    
    log_info "Installing LuCI Bandix Tools $luci_version..."
    
    if install_package_simple "/tmp/bandix/luci-app-bandix.ipk"; then
        ((packages_installed++))
        log_info "✓ LuCI Bandix Tools $luci_version berhasil diinstall"
    else
        ((packages_failed++))
        log_error "✗ Gagal install LuCI Bandix Tools"
    fi
    
    echo ""
    log_info "Hasil instalasi Bandix Tools:"
    log_info "  - Berhasil: $packages_installed packages"
    log_info "  - Core version: $core_version"
    log_info "  - LuCI version: $luci_version"
    if [ $packages_failed -gt 0 ]; then
        log_warn "  - Gagal: $packages_failed packages"
    fi
    
    rm -rf /tmp/bandix
    
    if [ $packages_installed -ge 2 ]; then
        log_info "Bandix Tools berhasil diinstall lengkap (core + luci)"
        return 0
    elif [ $packages_installed -eq 1 ]; then
        log_warn "Bandix Tools terinstall sebagian (hanya core)"
        return 1
    else
        log_error "Gagal install Bandix Tools"
        return 1
    fi
}

install_netmonitor() {
    log_blue "=========================================="
    log_blue "          INSTALL NETMONITOR"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/netmonitor
    
    log_info "Mengambil versi latest Netmonitor Tools dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/de-quenx/luci-app-netmonitor/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local netmonitor_url=$(echo "$latest_release" | grep "browser_download_url" | grep "_all.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$netmonitor_url" ]; then
        log_error "URL Netmonitor Tools tidak ditemukan"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "       DOWNLOAD LUCI-APP-NETMONITOR"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$netmonitor_url")"
    
    if ! download_file "$netmonitor_url" "/tmp/netmonitor/luci-app-netmonitor.ipk"; then
        log_error "Gagal download Netmonitor Tools"
        rm -rf /tmp/netmonitor
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "       INSTALL LUCI-APP-NETMONITOR"
    log_blue "=========================================="
    
    log_info "Installing Netmonitor Tools $version..."
    
    if install_package_simple "/tmp/netmonitor/luci-app-netmonitor.ipk"; then
        log_info "✓ Netmonitor Tools $version berhasil diinstall"
        rm -rf /tmp/netmonitor
        return 0
    else
        log_error "✗ Gagal install Netmonitor Tools"
        rm -rf /tmp/netmonitor
        return 1
    fi
}

install_modemdata() {
    log_blue "=========================================="
    log_blue "          INSTALL MODEMDATA"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/modemdata
    
    log_info "Mengambil versi latest Modemdata Tools dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/4IceG/luci-app-modemdata/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local modemdata_core_url=$(echo "$latest_release" | grep "browser_download_url" | grep "/modemdata" | grep "\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    local modemdata_luci_url=$(echo "$latest_release" | grep "browser_download_url" | grep "/luci-app-modemdata" | grep "\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$modemdata_core_url" ]; then
        log_error "URL Modemdata Core tidak ditemukan"
        return 1
    fi
    
    if [ -z "$modemdata_luci_url" ]; then
        log_error "URL LuCI Modemdata tidak ditemukan"
        return 1
    fi
    
    local packages_installed=0
    local packages_failed=0
    
    log_blue "=========================================="
    log_blue "          DOWNLOAD MODEMDATA"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$modemdata_core_url")"
    
    if ! download_file "$modemdata_core_url" "/tmp/modemdata/modemdata.ipk"; then
        log_error "Gagal download Modemdata Core"
        rm -rf /tmp/modemdata
        return 1
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "       DOWNLOAD LUCI-APP-MODEMDATA"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$modemdata_luci_url")"
    
    if ! download_file "$modemdata_luci_url" "/tmp/modemdata/luci-app-modemdata.ipk"; then
        log_error "Gagal download LuCI Modemdata"
        rm -rf /tmp/modemdata
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "           INSTALL MODEMDATA"
    log_blue "=========================================="
    
    log_info "Installing Modemdata Core $version (dependency)..."
    
    if install_package_simple "/tmp/modemdata/modemdata.ipk"; then
        ((packages_installed++))
        log_info "✓ Modemdata Core $version berhasil diinstall"
    else
        ((packages_failed++))
        log_error "✗ Gagal install Modemdata Core"
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "       INSTALL LUCI-APP-MODEMDATA"
    log_blue "=========================================="
    
    log_info "Installing LuCI Modemdata $version..."
    
    if install_package_simple "/tmp/modemdata/luci-app-modemdata.ipk"; then
        ((packages_installed++))
        log_info "✓ LuCI Modemdata $version berhasil diinstall"
    else
        ((packages_failed++))
        log_error "✗ Gagal install LuCI Modemdata"
    fi
    
    echo ""
    log_info "Hasil instalasi Modemdata Tools:"
    log_info "  - Berhasil: $packages_installed packages"
    log_info "  - Version: $version"
    if [ $packages_failed -gt 0 ]; then
        log_warn "  - Gagal: $packages_failed packages"
    fi
    
    rm -rf /tmp/modemdata
    
    if [ $packages_installed -ge 2 ]; then
        log_info "Modemdata Tools berhasil diinstall lengkap (core + luci)"
        return 0
    elif [ $packages_installed -eq 1 ]; then
        log_warn "Modemdata Tools terinstall sebagian (hanya core)"
        return 1
    else
        log_error "Gagal install Modemdata Tools"
        return 1
    fi
}

install_webdroidx() {
    log_blue "=========================================="
    log_blue "          INSTALL WEBDROIDX"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/webdroidx
    
    log_info "Mengambil versi latest Webdroidx Tools dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/bobbyunknown/WebDroidX/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local webdroidx_url=$(echo "$latest_release" | grep "browser_download_url" | grep "_all.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$webdroidx_url" ]; then
        log_error "URL Webdroidx Tools tidak ditemukan"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "       DOWNLOAD LUCI-APP-WEBDROIDX"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$webdroidx_url")"
    
    if ! download_file "$webdroidx_url" "/tmp/webdroidx/luci-app-webdroidx.ipk"; then
        log_error "Gagal download Webdroidx Tools"
        rm -rf /tmp/webdroidx
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "       INSTALL LUCI-APP-WEBDROIDX"
    log_blue "=========================================="
    
    log_info "Installing Webdroidx Tools $version..."
    
    if install_package_simple "/tmp/webdroidx/luci-app-webdroidx.ipk"; then
        log_info "✓ Webdroidx Tools $version berhasil diinstall"
        rm -rf /tmp/webdroidx
        return 0
    else
        log_error "✗ Gagal install Webdroidx Tools"
        rm -rf /tmp/webdroidx
        return 1
    fi
}

install_andromodem() {
    log_blue "=========================================="
    log_blue "           INSTALL ANDROMODEM"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/andromodem
    
    log_info "Mengambil versi latest Andromodem dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/bobbyunknown/andromodem/releases")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan:"
    log_info "  - Andromodem Core: $version"
    log_info "  - LuCI Andromodem: $version"
    
    local arch_pattern=""
    case "${ARCH_3}" in
        "x86_64")
            arch_pattern="x86_64"
            ;;
        "aarch64"*)
            arch_pattern="aarch64_generic"
            ;;
        *)
            log_error "Arsitektur tidak didukung untuk Andromodem: ${ARCH_3}"
            log_warn "Andromodem hanya support x86_64 dan aarch64"
            return 1
            ;;
    esac
    
    local andromodem_core_url=""
    
    if [ "$arch_pattern" = "aarch64" ]; then
        andromodem_core_url=$(echo "$latest_release" | grep "browser_download_url" | grep -E "andromodem_[^/]*_aarch64_generic\.ipk" | head -n 1 | cut -d '"' -f 4)
        
        if [ -z "$andromodem_core_url" ]; then
            andromodem_core_url=$(echo "$latest_release" | grep "browser_download_url" | grep -E "andromodem_[^/]*_aarch64_cortex-a53\.ipk" | head -n 1 | cut -d '"' -f 4)
        fi
        
        if [ -z "$andromodem_core_url" ]; then
            andromodem_core_url=$(echo "$latest_release" | grep "browser_download_url" | grep -E "andromodem_[^/]*_aarch64_cortex-a72\.ipk" | head -n 1 | cut -d '"' -f 4)
        fi
    else
        andromodem_core_url=$(echo "$latest_release" | grep "browser_download_url" | grep -E "andromodem_[^/]*_${arch_pattern}\.ipk" | head -n 1 | cut -d '"' -f 4)
    fi
    
    local andromodem_luci_url=$(echo "$latest_release" | grep "browser_download_url" | grep -E "luci-app-andromodem_[^/]*_all\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$andromodem_core_url" ]; then
        log_error "URL Andromodem core tidak ditemukan untuk arsitektur: ${arch_pattern}"
        log_info "File yang tersedia:"
        echo "$latest_release" | grep "browser_download_url" | grep "\.ipk" | cut -d '"' -f 4 | while read url; do
            log_info "  - $(basename "$url")"
        done
        return 1
    fi
    
    if [ -z "$andromodem_luci_url" ]; then
        log_error "URL LuCI Andromodem tidak ditemukan"
        return 1
    fi
    
    log_info "Arsitektur target: ${ARCH_3} → $(basename "$andromodem_core_url" | sed 's/.*_\(.*\)\.ipk/\1/')"
    
    local packages_installed=0
    local packages_failed=0
    
    log_blue "=========================================="
    log_blue "           DOWNLOAD ANDROMODEM"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$andromodem_core_url")"
    
    if ! download_file "$andromodem_core_url" "/tmp/andromodem/andromodem-core.ipk"; then
        log_error "Gagal download Andromodem core"
        rm -rf /tmp/andromodem
        return 1
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "        DOWNLOAD LUCI-APP-ANDROMODEM"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$andromodem_luci_url")"
    
    if ! download_file "$andromodem_luci_url" "/tmp/andromodem/luci-app-andromodem.ipk"; then
        log_error "Gagal download LuCI Andromodem"
        rm -rf /tmp/andromodem
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "            INSTALL ANDROMODEM"
    log_blue "=========================================="
    
    log_info "Installing Andromodem core $version (dependency)..."
    
    if install_package_simple "/tmp/andromodem/andromodem-core.ipk"; then
        ((packages_installed++))
        log_info "✓ Andromodem core $version berhasil diinstall"
    else
        ((packages_failed++))
        log_error "✗ Gagal install Andromodem core"
    fi
    
    echo ""
    log_blue "=========================================="
    log_blue "        INSTALL LUCI-APP-ANDROMODEM"
    log_blue "=========================================="
    
    log_info "Installing LuCI Andromodem $version..."
    
    if install_package_simple "/tmp/andromodem/luci-app-andromodem.ipk"; then
        ((packages_installed++))
        log_info "✓ LuCI Andromodem $version berhasil diinstall"
    else
        ((packages_failed++))
        log_error "✗ Gagal install LuCI Andromodem"
    fi
    
    echo ""
    log_info "Hasil instalasi Andromodem:"
    log_info "  - Berhasil: $packages_installed packages"
    log_info "  - Version: $version"
    if [ $packages_failed -gt 0 ]; then
        log_warn "  - Gagal: $packages_failed packages"
    fi
    
    rm -rf /tmp/andromodem
    
    if [ $packages_installed -ge 2 ]; then
        log_info "Andromodem berhasil diinstall lengkap (core + luci)"
        return 0
    elif [ $packages_installed -eq 1 ]; then
        log_warn "Andromodem terinstall sebagian (hanya core)"
        return 1
    else
        log_error "Gagal install Andromodem"
        return 1
    fi
}

rakitanmanager_menu() {
    echo ""
    log_blue "Select RakitanManager-Reborn:"
    echo ""
    echo "  1) Install"
    echo "  2) Uninstall"
    echo ""
    echo -n "Enter choice [1-2]: "
    read rm_choice
    
    case $rm_choice in
        1)
            install_rakitanmanager
            ;;
        2)
            uninstall_rakitanmanager
            ;;
        *)
            log_warn "Invalid choice, returning to menu"
            return 1
            ;;
    esac
}

install_rakitanmanager() {
    log_blue "=========================================="
    log_blue "     INSTALLING RAKITANMANAGER-REBORN"
    log_blue "=========================================="
    
    mkdir -p /tmp/rakitanmanager_install /usr/share/rakitanmanager /www/rakitanmanager
    
    log_info "Fetching RakitanManager repository..."
    
    if command -v git >/dev/null 2>&1; then
        log_info "Trying git clone..."
        if git clone --depth 1 "https://github.com/rtaserver-wrt/RakitanManager-Reborn" /tmp/rakitanmanager_install 2>/dev/null; then
            log_info "Git clone successful"
        else
            log_warn "Git clone failed, trying wget fallback..."
            rm -rf /tmp/rakitanmanager_install 2>/dev/null
            mkdir -p /tmp/rakitanmanager_install
            
            if command -v wget >/dev/null 2>&1; then
                if wget -O /tmp/rakitanmanager_install/main.zip "https://github.com/rtaserver-wrt/RakitanManager-Reborn/archive/refs/heads/main.zip" 2>/dev/null; then
                    cd /tmp/rakitanmanager_install
                    if unzip -q main.zip 2>/dev/null; then
                        mv RakitanManager-Reborn-main/* . 2>/dev/null
                        rm -f main.zip 2>/dev/null
                        rm -rf RakitanManager-Reborn-main 2>/dev/null
                        log_info "Download successful using wget"
                    else
                        log_warn "Failed to extract downloaded file"
                        rm -rf /tmp/rakitanmanager_install 2>/dev/null
                        return 1
                    fi
                else
                    log_warn "Wget download failed, trying curl..."
                    if command -v curl >/dev/null 2>&1; then
                        if curl -L -o /tmp/rakitanmanager_install/main.zip "https://github.com/rtaserver-wrt/RakitanManager-Reborn/archive/refs/heads/main.zip" 2>/dev/null; then
                            cd /tmp/rakitanmanager_install
                            if unzip -q main.zip 2>/dev/null; then
                                mv RakitanManager-Reborn-main/* . 2>/dev/null
                                rm -f main.zip 2>/dev/null
                                rm -rf RakitanManager-Reborn-main 2>/dev/null
                                log_info "Download successful using curl"
                            else
                                log_warn "Failed to extract downloaded file"
                                rm -rf /tmp/rakitanmanager_install 2>/dev/null
                                return 1
                            fi
                        else
                            log_warn "All download methods failed"
                            rm -rf /tmp/rakitanmanager_install 2>/dev/null
                            return 1
                        fi
                    else
                        log_warn "No download tool available"
                        rm -rf /tmp/rakitanmanager_install 2>/dev/null
                        return 1
                    fi
                fi
            else
                log_warn "Wget not available, trying curl..."
                if command -v curl >/dev/null 2>&1; then
                    if curl -L -o /tmp/rakitanmanager_install/main.zip "https://github.com/rtaserver-wrt/RakitanManager-Reborn/archive/refs/heads/main.zip" 2>/dev/null; then
                        cd /tmp/rakitanmanager_install
                        if unzip -q main.zip 2>/dev/null; then
                            mv RakitanManager-Reborn-main/* . 2>/dev/null
                            rm -f main.zip 2>/dev/null
                            rm -rf RakitanManager-Reborn-main 2>/dev/null
                            log_info "Download successful using curl"
                        else
                            log_warn "Failed to extract downloaded file"
                            rm -rf /tmp/rakitanmanager_install 2>/dev/null
                            return 1
                        fi
                    else
                        log_warn "All download methods failed"
                        rm -rf /tmp/rakitanmanager_install 2>/dev/null
                        return 1
                    fi
                else
                    log_warn "No download tool available"
                    rm -rf /tmp/rakitanmanager_install 2>/dev/null
                    return 1
                fi
            fi
        fi
    else
        log_warn "Git not available, trying wget..."
        if command -v wget >/dev/null 2>&1; then
            if wget -O /tmp/rakitanmanager_install/main.zip "https://github.com/rtaserver-wrt/RakitanManager-Reborn/archive/refs/heads/main.zip" 2>/dev/null; then
                cd /tmp/rakitanmanager_install
                if unzip -q main.zip 2>/dev/null; then
                    mv RakitanManager-Reborn-main/* . 2>/dev/null
                    rm -f main.zip 2>/dev/null
                    rm -rf RakitanManager-Reborn-main 2>/dev/null
                    log_info "Download successful using wget"
                else
                    log_warn "Failed to extract downloaded file"
                    rm -rf /tmp/rakitanmanager_install 2>/dev/null
                    return 1
                fi
            else
                log_warn "Wget failed, trying curl..."
                if command -v curl >/dev/null 2>&1; then
                    if curl -L -o /tmp/rakitanmanager_install/main.zip "https://github.com/rtaserver-wrt/RakitanManager-Reborn/archive/refs/heads/main.zip" 2>/dev/null; then
                        cd /tmp/rakitanmanager_install
                        if unzip -q main.zip 2>/dev/null; then
                            mv RakitanManager-Reborn-main/* . 2>/dev/null
                            rm -f main.zip 2>/dev/null
                            rm -rf RakitanManager-Reborn-main 2>/dev/null
                            log_info "Download successful using curl"
                        else
                            log_warn "Failed to extract downloaded file"
                            rm -rf /tmp/rakitanmanager_install 2>/dev/null
                            return 1
                        fi
                    else
                        log_warn "All download methods failed"
                        rm -rf /tmp/rakitanmanager_install 2>/dev/null
                        return 1
                    fi
                else
                    log_warn "No download tool available"
                    rm -rf /tmp/rakitanmanager_install 2>/dev/null
                    return 1
                fi
            fi
        else
            log_warn "No download tool available"
            rm -rf /tmp/rakitanmanager_install 2>/dev/null
            return 1
        fi
    fi
    
    PACKAGE_BASE="coreutils-sleep curl git git-http bc screen adb httping jq procps-ng-pkill unzip dos2unix"
    PACKAGE_PYTHON="python3-pip python3-requests python3-setuptools"
    PACKAGE_PHP7="php7-mod-curl php7-mod-session php7-mod-zip php7-cgi"
    PACKAGE_PHP8="php8-mod-curl php8-mod-session php8-mod-zip php8-cgi"
    
    log_info "Detecting PHP version..."
    
    PHP_VERSION=""
    if opkg list-installed | grep -q "^php8 "; then
        PHP_VERSION="php8"
        log_info "PHP 8 detected"
    elif opkg list-installed | grep -q "^php7 "; then
        PHP_VERSION="php7"
        log_info "PHP 7 detected"
    else
        if opkg list | grep -q "^php8 "; then
            PHP_VERSION="php8"
            log_info "PHP 8 available, will be installed"
        elif opkg list | grep -q "^php7 "; then
            PHP_VERSION="php7"
            log_info "PHP 7 available, will be installed"
        else
            log_warn "No PHP version found"
            PHP_VERSION="php8"
        fi
    fi
    
    if [ "$PHP_VERSION" = "php8" ]; then
        PACKAGE_PHP="$PACKAGE_PHP8"
    else
        PACKAGE_PHP="$PACKAGE_PHP7"
    fi
    
    log_info "Checking and installing dependencies..."
    
    FAILED_PACKAGES=""
    for package in $PACKAGE_BASE $PACKAGE_PHP $PACKAGE_PYTHON; do
        if opkg list-installed | grep -q "^$package "; then
            log_info "$package already installed, skipping..."
        else
            log_info "Installing $package..."
            if ! opkg install "$package" 2>/dev/null; then
                log_warn "Failed to install $package"
                FAILED_PACKAGES="$FAILED_PACKAGES $package"
            fi
        fi
    done
    
    if [ -n "$FAILED_PACKAGES" ]; then
        log_warn "Failed to install required packages:$FAILED_PACKAGES"
        log_warn "Installation failed"
        rm -rf /tmp/rakitanmanager_install 2>/dev/null
        return 1
    fi
    
    log_info "Stopping existing services..."
    if [ -f /etc/init.d/rakitanmanager ]; then
        /etc/init.d/rakitanmanager stop 2>/dev/null
    fi
    
    if pidof core-manager.sh >/dev/null; then
        killall -9 core-manager.sh 2>/dev/null
    fi
    
    log_info "Backing up existing configuration..."
    if [ -f /usr/share/rakitanmanager/modems.json ]; then
        mkdir -p /tmp/rakitanmanager_install/backup
        cp -f /usr/share/rakitanmanager/modems.json /tmp/rakitanmanager_install/backup/modems.json 2>/dev/null
    fi
    
    if [ -f /etc/config/rakitanmanager ]; then
        mkdir -p /tmp/rakitanmanager_install/backup
        cp -f /etc/config/rakitanmanager /tmp/rakitanmanager_install/backup/rakitanmanager 2>/dev/null
    fi
    
    log_info "Installing core files..."
    rm -rf /usr/share/rakitanmanager 2>/dev/null
    mkdir -p /usr/share/rakitanmanager
    cp -rf /tmp/rakitanmanager_install/rakitanmanager/core/. /usr/share/rakitanmanager/ 2>/dev/null
    
    log_info "Installing web interface..."
    rm -rf /www/rakitanmanager 2>/dev/null
    mkdir -p /www/rakitanmanager
    cp -rf /tmp/rakitanmanager_install/rakitanmanager/web/. /www/rakitanmanager/ 2>/dev/null
    
    log_info "Installing init script..."
    rm -f /etc/init.d/rakitanmanager 2>/dev/null
    cp -f /tmp/rakitanmanager_install/rakitanmanager/init.d/rakitanmanager /etc/init.d/rakitanmanager 2>/dev/null
    chmod +x /etc/init.d/rakitanmanager 2>/dev/null
    
    log_info "Installing configuration..."
    rm -f /etc/config/rakitanmanager 2>/dev/null
    cp -f /tmp/rakitanmanager_install/rakitanmanager/config/rakitanmanager /etc/config/rakitanmanager 2>/dev/null
    
    log_info "Restoring backups..."
    if [ -f /tmp/rakitanmanager_install/backup/modems.json ]; then
        cp -f /tmp/rakitanmanager_install/backup/modems.json /usr/share/rakitanmanager/modems.json 2>/dev/null
    fi
    
    if [ -f /tmp/rakitanmanager_install/backup/rakitanmanager ]; then
        cp -f /tmp/rakitanmanager_install/backup/rakitanmanager /etc/config/rakitanmanager 2>/dev/null
    fi
    
    log_info "Creating LuCI integration..."
    mkdir -p /usr/lib/lua/luci/view /usr/lib/lua/luci/controller
    
    cat > /usr/lib/lua/luci/view/rakitanmanager.htm << 'EOF'
<%+header%>
<div class="cbi-map">
<iframe id="rakitanmanager" style="width: 100%; min-height: 750px; border: none; border-radius: 2px;"></iframe>
</div>
<script type="text/javascript">
document.getElementById("rakitanmanager").src = "http://" + window.location.hostname + "/rakitanmanager/index.php";
</script>
<%+footer%>
EOF
    
    cat > /usr/lib/lua/luci/controller/rakitanmanager.lua << 'EOF'
module("luci.controller.rakitanmanager", package.seeall)
function index()
    entry({"admin","modem","rakitanmanager"}, template("rakitanmanager"), _("Rakitan Manager"), 7).leaf=true
end
EOF
    
    log_info "Setting permissions..."
    find /usr/share/rakitanmanager -type f \( -name "*.sh" -o -name "*.py" \) -exec chmod +x {} \; 2>/dev/null
    chown -R root:root /usr/share/rakitanmanager /www/rakitanmanager 2>/dev/null
    
    log_info "Enabling service..."
    /etc/init.d/rakitanmanager enable 2>/dev/null
    
    log_info "Cleaning up..."
    rm -rf /tmp/rakitanmanager_install 2>/dev/null
    
    log_info "RakitanManager-Reborn installed successfully!"
}

uninstall_rakitanmanager() {
    log_blue "=========================================="
    log_blue "    UNINSTALLING RAKITANMANAGER-REBORN"
    log_blue "=========================================="
    
    log_info "Stopping services..."
    if [ -f /etc/init.d/rakitanmanager ]; then
        /etc/init.d/rakitanmanager stop 2>/dev/null
        /etc/init.d/rakitanmanager disable 2>/dev/null
    fi
    
    if pidof core-manager.sh >/dev/null; then
        killall -9 core-manager.sh 2>/dev/null
    fi
    
    log_info "Removing files..."
    rm -rf /usr/share/rakitanmanager 2>/dev/null
    rm -rf /www/rakitanmanager 2>/dev/null
    rm -f /etc/init.d/rakitanmanager 2>/dev/null
    rm -f /etc/config/rakitanmanager 2>/dev/null
    rm -f /usr/lib/lua/luci/view/rakitanmanager.htm 2>/dev/null
    rm -f /usr/lib/lua/luci/controller/rakitanmanager.lua 2>/dev/null
    
    log_info "Removing UCI configuration..."
    if command -v uci >/dev/null 2>&1; then
        uci delete rakitanmanager 2>/dev/null
        uci commit 2>/dev/null
    fi
    
    log_info "Removing dependencies..."
    PACKAGE_REMOVE="python3-requests python3-pip python3-setuptools procps-ng-pkill dos2unix"
    for package in $PACKAGE_REMOVE; do
        if opkg list-installed | grep -q "^$package "; then
            log_info "Removing $package..."
            opkg remove --force-depends "$package" 2>/dev/null
        fi
    done
    
    log_info "RakitanManager-Reborn uninstalled successfully!"
}

adguardhome_menu() {
    echo ""
    log_blue "Select AdGuardHome:"
    echo ""
    echo "  1) Install AdGuardHome"
    echo "  2) Uninstall AdGuardHome"
    echo "  3) Enable AdGuardHome"
    echo "  4) Disable AdGuardHome"
    echo "  5) Configure DNS AGH × OpenClash"
    echo "  6) Remove Configure DNS AGH × OpenClash"
    echo ""
    echo -n "Enter choice [1-6]: "
    read agh_choice
    
    case $agh_choice in
        1)
            install_adguardhome
            ;;
        2)
            uninstall_adguardhome
            ;;
        3)
            enable_agh
            ;;
        4)
            disable_agh
            ;;
        5)
            configure_agh_openclash
            ;;
        6)
            remove_configure_agh_openclash
            ;;
        *)
            log_warn "Invalid choice, returning to menu"
            return 1
            ;;
    esac
}

download_file() {
    local url="$1"
    local output="$2"
    local max_attempts=3
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if wget -q -O "$output" "$url"; then
            return 0
        else
            log_warn "Download gagal (percobaan $attempt/$max_attempts)"
            [ $attempt -lt $max_attempts ] && sleep 2
            attempt=$((attempt + 1))
        fi
    done
    
    return 1
}

install_adguardhome() {
    log_blue "=========================================="
    log_blue "      INSTALLING ADGUARDHOME"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/adguardhome
    
    log_info "Mengambil versi latest AdGuardHome LuCI dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/de-quenx/luci-app-adguardhome/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local agh_ipk=$(echo "$latest_release" | grep "browser_download_url" | grep "\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$agh_ipk" ]; then
        log_error "URL AdGuardHome LuCI tidak ditemukan"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "       DOWNLOAD LUCI-APP-ADGUARDHOME"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$agh_ipk")"
    
    if ! download_file "$agh_ipk" "/tmp/adguardhome/luci-app-adguardhome.ipk"; then
        log_error "Gagal download LuCI AdGuardHome"
        rm -rf /tmp/adguardhome
        return 1
    fi
    
    log_info "Mengambil versi latest AdGuardHome Core dari GitHub..."
    
    local core_release=$(curl -s "https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest")
    
    if [ -z "$core_release" ]; then
        log_error "Gagal mengambil informasi core release dari GitHub"
        return 1
    fi
    
    local core_version=$(echo "$core_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi core latest ditemukan: $core_version"
    
    local arch_suffix=""
    case "${ARCH_3}" in
        "x86_64")
            arch_suffix="amd64"
            ;;
        "aarch64"*)
            arch_suffix="arm64"
            ;;
        *)
            log_error "Arsitektur tidak didukung untuk AdGuardHome: ${ARCH_3}"
            log_warn "AdGuardHome hanya support x86_64 dan aarch64"
            return 1
            ;;
    esac
    
    log_info "Arsitektur target: ${ARCH_3} → $arch_suffix"
    
    local agh_core_url=$(echo "$core_release" | grep "browser_download_url" | grep "AdGuardHome_linux_${arch_suffix}" | grep "\.tar\.gz" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$agh_core_url" ]; then
        log_error "URL AdGuardHome core tidak ditemukan untuk arsitektur: $arch_suffix"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "        DOWNLOAD ADGUARDHOME CORE"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$agh_core_url")"
    
    if ! download_file "$agh_core_url" "/tmp/adguardhome/AdGuardHome_core.tar.gz"; then
        log_error "Gagal download AdGuardHome core"
        rm -rf /tmp/adguardhome
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "        INSTALLING PACKAGES"
    log_blue "=========================================="
    
    packages=("adguardhome" "luci-app-adguardhome")
    for package in "${packages[@]}"; do
        if opkg list-installed | grep -q "^$package"; then
            log_info "$package sudah terinstall. Menghapus..."
            opkg remove "$package" --force-remove >/dev/null 2>&1
            log_info "Selesai, melanjutkan proses."
        fi
    done
    rm -f /etc/config/AdGuardHome >/dev/null 2>&1
    
    [ "$opkg_updated" = false ] && { 
        log_info "Memperbarui daftar paket..."
        opkg update || { 
            log_error "Gagal memperbarui opkg!"
            rm -rf /tmp/adguardhome
            exit 1
        }
        opkg_updated=true
    }
    
    log_info "Menginstall luci-app-adguardhome..."
    if opkg install /tmp/adguardhome/luci-app-adguardhome.ipk; then
        log_info "LuCI AdGuardHome berhasil diinstall."
    else
        log_error "Gagal menginstall luci-app-adguardhome!"
        rm -rf /tmp/adguardhome
        exit 1
    fi
    
    log_blue "=========================================="
    log_blue "        INSTALLING CORE"
    log_blue "=========================================="
    
    [ ! -d "/opt" ] && mkdir -p /opt
    if [ -d "/opt/AdGuardHome" ]; then
        log_info "Direktori AdGuardHome sudah ada, membersihkan..."
        find "/opt/AdGuardHome" -type f ! -name '*.yaml' -exec rm {} \;
    fi
    
    log_info "Mengekstrak AdGuardHome core..."
    if tar -zxf "/tmp/adguardhome/AdGuardHome_core.tar.gz" -C /opt; then
        log_info "AdGuardHome core version $core_version berhasil diinstall"
    else
        log_error "Gagal mengekstrak core!"
        rm -rf /tmp/adguardhome
        exit 1
    fi
    
    log_info "Mengkonfigurasi AdGuardHome..."
    if ! download_file "https://github.com/frizkyiman/friWrt-MyWrtBuilder/raw/main/files/opt/AdGuardHome/AdGuardHome.yaml" "/opt/AdGuardHome/AdGuardHome.yaml"; then
        log_warn "Gagal download konfigurasi default, menggunakan konfigurasi kosong"
    fi
    
    uci set AdGuardHome.AdGuardHome.enabled='0'
    uci set AdGuardHome.AdGuardHome.httpport='3000'
    uci set AdGuardHome.AdGuardHome.redirect='exchange'
    uci set AdGuardHome.AdGuardHome.configpath='/opt/AdGuardHome/AdGuardHome.yaml'
    uci set AdGuardHome.AdGuardHome.workdir='/opt/AdGuardHome'
    uci set AdGuardHome.AdGuardHome.binpath='/opt/AdGuardHome/AdGuardHome'
    uci set AdGuardHome.AdGuardHome.logfile='/tmp/AdGuardHome.log'
    uci set AdGuardHome.AdGuardHome.verbose='0'
    uci commit AdGuardHome
    
    setup_dashboard
    
    if check_openclash_installed; then
        echo ""
        echo -n "Configure OpenClash DNS settings? (y/n) [Auto: n in 6s]: "
        if read -t 6 -r configure_openclash; then
            :
        else
            configure_openclash="n"
            echo "n"
        fi
        
        case "$configure_openclash" in
            [Yy])
                manage_openclash_configuration
                ;;
            *)
                log_info "OpenClash DNS configuration skipped."
                ;;
        esac
    fi
    
    echo ""
    echo -n "Enable AdGuardHome now? (y/n) [Auto: y in 5s]: "
    if read -t 5 -r enable_choice; then
        :
    else
        enable_choice="y"
        echo "y"
    fi
    
    case "$enable_choice" in
        [Nn])
            log_info "AdGuardHome installed but not enabled."
            ;;
        *)
            enable_agh
            ;;
    esac
    
    rm -rf /tmp/adguardhome
    
    log_info "AdGuardHome installation completed!"
}

enable_agh() {
    log_blue "=========================================="
    log_blue "       ENABLING ADGUARDHOME"
    log_blue "=========================================="
    
    log_info "Enabling AdGuard Home..."
    uci set AdGuardHome.AdGuardHome.httpport='3000'
    uci set AdGuardHome.AdGuardHome.redirect='exchange'
    uci set AdGuardHome.AdGuardHome.configpath='/opt/AdGuardHome/AdGuardHome.yaml'
    uci set AdGuardHome.AdGuardHome.workdir='/opt/AdGuardHome'
    uci set AdGuardHome.AdGuardHome.logfile='/tmp/AdGuardHome.log'
    uci set AdGuardHome.AdGuardHome.binpath='/opt/AdGuardHome/AdGuardHome'
    uci set AdGuardHome.AdGuardHome.verbose='0'
    uci commit AdGuardHome

    NET_ADDR=$(uci get network.lan.ipaddr)
    NET_ADDR6=$(/sbin/ip -o -6 addr list br-lan scope global | awk 'NR==1{ split($4, ip_addr, "/"); print ip_addr[1] }')
 
    log_info "Router IPv4 : ${NET_ADDR}"
    log_info "Router IPv6 : ${NET_ADDR6}"

    sed -i "s/local_ptr_upstreams: \[\]/local_ptr_upstreams:\n    - ${NET_ADDR}:54/" /opt/AdGuardHome/AdGuardHome.yaml
    sed -i '/port: 6060/! s/\(port:\s*\)[0-9]*/\153/' /opt/AdGuardHome/AdGuardHome.yaml

    uci set dhcp.@dnsmasq[0].noresolv='0'
    uci set dhcp.@dnsmasq[0].cachesize='1000'
    uci set dhcp.@dnsmasq[0].rebind_protection='0'
    uci set dhcp.@dnsmasq[0].port='54'

    uci -q delete dhcp.@dnsmasq[0].server
    uci add_list dhcp.@dnsmasq[0].server="${NET_ADDR}"

    uci set dhcp.lan.leasetime='24h' 
    uci -q delete dhcp.lan.dhcp_option
    uci -q delete dhcp.lan.dns

    uci add_list dhcp.lan.dhcp_option='6,'"${NET_ADDR}" 
    uci add_list dhcp.lan.dhcp_option='3,'"${NET_ADDR}"

    for OUTPUT in $(ip -o -6 addr list br-lan scope global | awk '{ split($4, ip_addr, "/"); print ip_addr[1] }')
    do
      	uci add_list dhcp.lan.dns=$OUTPUT
    done

    uci commit dhcp
    /etc/init.d/dnsmasq restart >/dev/null 2>&1

    if [ -n "$(command -v fw4)" ]; then
       uci set firewall.adguardhome_dns_53="redirect"
       uci set firewall.adguardhome_dns_53.src='lan'
       uci set firewall.adguardhome_dns_53.proto='tcp udp'
       uci set firewall.adguardhome_dns_53.src_dport='53'
       uci set firewall.adguardhome_dns_53.target='DNAT'
       uci set firewall.adguardhome_dns_53.name='AdGuard Home'
       uci set firewall.adguardhome_dns_53.dest='lan'
       uci set firewall.adguardhome_dns_53.dest_ip="${NET_ADDR}"
       uci set firewall.adguardhome_dns_53.dest_port='53'
       uci commit firewall
    fi

    uci set AdGuardHome.AdGuardHome.enabled='1'
    uci commit AdGuardHome
    /etc/init.d/AdGuardHome enable
    /etc/init.d/AdGuardHome start
    /etc/init.d/firewall restart >/dev/null 2>&1
    
    check_openclash_installed && manage_openclash_configuration
    
    log_info "AdGuardHome Successfully Enabled!"
}

disable_agh() {
    log_blue "=========================================="
    log_blue "       DISABLING ADGUARDHOME"
    log_blue "=========================================="
    
    log_info "Disabling AdGuard Home..."
    uci -q delete dhcp.@dnsmasq[0].noresolv
    uci -q delete dhcp.@dnsmasq[0].cachesize
    uci set dhcp.@dnsmasq[0].port='53'
    uci set dhcp.@dnsmasq[0].rebind_protection='1'

    uci -q delete dhcp.@dnsmasq[0].server
    uci -q delete dhcp.@dnsmasq[0].port
    uci -q delete dhcp.lan.dhcp_option
    uci -q delete dhcp.lan.dns
    uci commit dhcp
    /etc/init.d/dnsmasq restart >/dev/null 2>&1

    if [ -n "$(command -v fw4)" ]; then
       uci delete firewall.adguardhome_dns_53
       uci commit firewall
    fi

    uci set AdGuardHome.AdGuardHome.enabled='0'
    uci commit AdGuardHome
    /etc/init.d/AdGuardHome stop
    /etc/init.d/AdGuardHome disable
    /etc/init.d/firewall restart >/dev/null 2>&1
    log_info "AdGuardHome Successfully Disabled!"
}

configure_agh_openclash() {
    log_blue "=========================================="
    log_blue "   CONFIGURE DNS AGH × OPENCLASH"
    log_blue "=========================================="
    
    if ! check_openclash_installed; then
        log_error "OpenClash is not installed!"
        return 1
    fi
    
    log_info "Configuring OpenClash DNS settings for AdGuardHome..."
    uci set openclash.config.enable_custom_dns='0'
    uci set openclash.config.ipv6_dns='0'
    uci set openclash.config.cachesize_dns='0'
    uci set openclash.config.append_wan_dns='0'
    uci set openclash.config.append_default_dns='0'
    uci set openclash.config.enable_custom_domain_dns_server='0'
    uci set openclash.config.redirect_dns='0'
    uci set openclash.config.enable_redirect_dns='0'
    uci commit openclash
    
    log_info "OpenClash DNS configuration updated for AdGuardHome compatibility!"
    
    if ps | grep -q "[o]penclash"; then
        echo -n "Restart OpenClash service? (y/n) [Auto: n in 6s]: "
        if read -t 6 -r restart_choice; then
            :
        else
            restart_choice="n"
            echo "n"
        fi
        case "$restart_choice" in
            [Yy])
                log_info "Restarting OpenClash service..."
                /etc/init.d/openclash restart
                log_info "OpenClash service restarted!"
                ;;
            *)
                log_info "OpenClash service not restarted."
                ;;
        esac
    fi
}

remove_configure_agh_openclash() {
    log_blue "=========================================="
    log_blue " REMOVE CONFIGURE DNS AGH × OPENCLASH"
    log_blue "=========================================="
    
    if ! check_openclash_installed; then
        log_error "OpenClash is not installed!"
        return 1
    fi
    
    log_info "Restoring OpenClash DNS settings to default..."
    uci set openclash.config.enable_custom_dns='1'
    uci set openclash.config.ipv6_dns='1'
    uci set openclash.config.cachesize_dns='1000'
    uci set openclash.config.append_wan_dns='1'
    uci set openclash.config.append_default_dns='1'
    uci set openclash.config.enable_custom_domain_dns_server='1'
    uci set openclash.config.redirect_dns='1'
    uci set openclash.config.enable_redirect_dns='1'
    uci commit openclash
    
    log_info "OpenClash DNS configuration restored to default!"
    
    if ps | grep -q "[o]penclash"; then
        echo -n "Restart OpenClash service? (y/n) [Auto: n in 6s]: "
        if read -t 6 -r restart_choice; then
            :
        else
            restart_choice="n"
            echo "n"
        fi
        case "$restart_choice" in
            [Yy])
                log_info "Restarting OpenClash service..."
                /etc/init.d/openclash restart
                log_info "OpenClash service restarted!"
                ;;
            *)
                log_info "OpenClash service not restarted."
                ;;
        esac
    fi
}

check_openclash_installed() {
    if opkg list-installed | grep -q "openclash"; then
        return 0
    else
        log_info "OpenClash is not installed."
        return 1
    fi
}

manage_openclash_configuration() {
    is_openclash_running() {
        ps | grep -q "[o]penclash"
    }
    
    log_info "OpenClash detected, checking DNS configuration..."
    
    if ! uci show openclash | grep -qE "^openclash\.config\.enable_custom_dns='0'$" \
        || ! uci show openclash | grep -qE "^openclash\.config\.ipv6_dns='0'$" \
        || ! uci show openclash | grep -qE "^openclash\.config\.cachesize_dns='0'$" \
        || ! uci show openclash | grep -qE "^openclash\.config\.append_wan_dns='0'$" \
        || ! uci show openclash | grep -qE "^openclash\.config\.append_default_dns='0'$" \
        || ! uci show openclash | grep -qE "^openclash\.config\.enable_custom_domain_dns_server='0'$" \
        || ! uci show openclash | grep -qE "^openclash\.config\.redirect_dns='0'$" \
        || ! uci show openclash | grep -qE "^openclash\.config\.enable_redirect_dns='0'$"; then

        echo ""
        echo -n "Configure OpenClash DNS settings? (y/n) [Auto: n in 6s]: "
        if read -t 6 -r configure_openclash; then
            :
        else
            configure_openclash="n"
            echo "n"
        fi
        
        case "$configure_openclash" in
            [Yy])
                uci set openclash.config.enable_custom_dns='0'
                uci set openclash.config.ipv6_dns='0'
                uci set openclash.config.cachesize_dns='0'
                uci set openclash.config.append_wan_dns='0'
                uci set openclash.config.append_default_dns='0'
                uci set openclash.config.enable_custom_domain_dns_server='0'
                uci set openclash.config.redirect_dns='0'
                uci set openclash.config.enable_redirect_dns='0'
                uci commit openclash
                log_info "Openclash DNS Configuration updated."
                
                if is_openclash_running; then
                    echo -n "Restart OpenClash service? (y/n) [Auto: n in 6s]: "
                    if read -t 6 -r restart_choice; then
                        :
                    else
                        restart_choice="n"
                        echo "n"
                    fi
                    case "$restart_choice" in
                        [Yy])
                            log_info "Restarting OpenClash service..."
                            /etc/init.d/openclash restart
                            log_info "Done!"
                            ;;
                        *)
                            log_info "OpenClash service not restarted."
                            ;;
                    esac
                fi
                ;;
            *)
                log_warn "OpenClash DNS configuration skipped."
                ;;
        esac
    else
        log_info "Openclash DNS configuration is OK."
    fi
}

setup_dashboard() {
    if ! grep -q 'entry({"admin","services","AdGuardHome", "agh"}, template("AdGuardHome"), _("Dashboard")).leaf=true' /usr/lib/lua/luci/controller/AdGuardHome.lua; then
      sed -i '/Manual Config/ a\entry({"admin","services","AdGuardHome", "agh"}, template("AdGuardHome"), _("Dashboard")).leaf=true' /usr/lib/lua/luci/controller/AdGuardHome.lua
    fi

cat <<'EOF' >/usr/lib/lua/luci/view/AdGuardHome.htm
<%+header%>
<div class="cbi-map"><br>
<iframe id="agh" style="width: 100%; min-height: 650px; border: none; border-radius: 2px;"></iframe>
</div>
<script type="text/javascript">
document.getElementById("agh").src = "http://" + window.location.hostname + ":3000";
</script>
<%+footer%>
EOF

cat <<'EOF' >/www/agh.php
<script type="text/javascript">
document.getElementById("agh").src = "http://" + window.location.hostname + ":3000";
</script>
EOF
}

uninstall_adguardhome() {
    log_blue "=========================================="
    log_blue "      UNINSTALLING ADGUARDHOME"
    log_blue "=========================================="
    
    log_info "Stopping AdGuardHome services..."
    /etc/init.d/AdGuardHome stop 2>/dev/null
    /etc/init.d/AdGuardHome disable 2>/dev/null
    
    log_info "Removing packages..."
    packages=("adguardhome" "luci-app-adguardhome")
    for package in "${packages[@]}"; do
        if opkg list-installed | grep -q "^$package"; then
            log_info "Removing $package..."
            opkg remove "$package" --force-remove >/dev/null 2>&1
        fi
    done
    
    log_info "Removing files and directories..."
    rm -rf /opt/AdGuardHome 2>/dev/null
    rm -f /etc/config/AdGuardHome 2>/dev/null
    rm -f /usr/lib/lua/luci/view/AdGuardHome.htm 2>/dev/null
    rm -f /www/agh.php 2>/dev/null
    
    log_info "Restoring DNS configuration..."
    uci -q delete dhcp.@dnsmasq[0].noresolv
    uci -q delete dhcp.@dnsmasq[0].cachesize
    uci set dhcp.@dnsmasq[0].port='53'
    uci set dhcp.@dnsmasq[0].rebind_protection='1'
    uci -q delete dhcp.@dnsmasq[0].server
    uci -q delete dhcp.lan.dhcp_option
    uci -q delete dhcp.lan.dns
    uci commit dhcp
    
    log_info "Removing firewall rules..."
    if [ -n "$(command -v fw4)" ]; then
       uci -q delete firewall.adguardhome_dns_53
       uci commit firewall
    fi
    
    log_info "Restarting services..."
    /etc/init.d/dnsmasq restart >/dev/null 2>&1
    /etc/init.d/firewall restart >/dev/null 2>&1
    
    log_info "AdGuardHome uninstalled successfully!"
}

select_fixttl_menu() {
    echo ""
    log_blue "Select Fix TTL:"
    echo ""
    echo "  1) Install"
    echo "  2) Uninstall"
    echo ""
    echo -n "Enter choice [1-2]: "
    read ttl_choice
    
    case $ttl_choice in
        1)
            install_fixttl
            ;;
        2)
            uninstall_fixttl
            ;;
        *)
            log_warn "Invalid choice, returning to menu"
            return 1
            ;;
    esac
}

install_fixttl() {
    log_blue "=========================================="
    log_blue "           INSTALLING FIX TTL"
    log_blue "=========================================="
    
    log_info "Installing Fix TTL..."
    
    TTL_FILE="/etc/nftables.d/ttl67.nft"
    QUENX_LUA="/usr/lib/lua/luci/controller/quenx/quenx.lua"
    PAGE_HTM="/usr/lib/lua/luci/view/quenx/page.htm"

    hapus_jika_ada() {
        local file_path="$1"
        if [ -e "$file_path" ]; then
            rm -f "$file_path"
        fi
    }

    hapus_jika_ada "$TTL_FILE"
    hapus_jika_ada "$QUENX_LUA"
    hapus_jika_ada "$PAGE_HTM"

    buat_file_ttl() {
        local ttl_value="$1"
        mkdir -p "$(dirname "$TTL_FILE")"
        cat <<EOL > "$TTL_FILE"
chain mangle_postrouting_ttl67 {
    type filter hook postrouting priority 300; policy accept;
    counter ip ttl set $ttl_value
}
chain mangle_prerouting_ttl67 {
    type filter hook prerouting priority 300; policy accept;
    counter ip ttl set $ttl_value
}
EOL
    }

    buat_quenx_lua() {
        mkdir -p "$(dirname "$QUENX_LUA")"
        cat <<'EOL' > "$QUENX_LUA"
module("luci.controller.quenx.quenx", package.seeall)

function index()
    entry({"admin", "network", "quenx"}, call("render_page"), _("Fix TTL"), 100).leaf = true
end

function get_current_ttl()
    local output = luci.sys.exec("nft list chain inet fw4 mangle_postrouting_ttl67 2>/dev/null")
    if output and output:match("ip ttl set (%d+)") then
        return tonumber(output:match("ip ttl set (%d+)"))
    end
    return nil
end

function is_ttl_enabled()
    local output = luci.sys.exec("nft list chain inet fw4 mangle_postrouting_ttl67 2>/dev/null")
    return output and output:match("ip ttl set") ~= nil
end

function set_ttl(new_ttl)
    local ttl_file = "/etc/nftables.d/ttl67.nft"
    local ttl_rule = string.format([[
chain mangle_postrouting_ttl67 {
    type filter hook postrouting priority 300; policy accept;
    counter ip ttl set %d
}
chain mangle_prerouting_ttl67 {
    type filter hook prerouting priority 300; policy accept;
    counter ip ttl set %d
}
]], new_ttl, new_ttl)

    local f = io.open(ttl_file, "w")
    if f then
        f:write(ttl_rule)
        f:close()
    end

    luci.sys.call("nft -f " .. ttl_file)
    luci.sys.call("/etc/init.d/firewall restart")
end

function disable_ttl()
    local ttl_file = "/etc/nftables.d/ttl67.nft"
    
    luci.sys.call("nft delete chain inet fw4 mangle_postrouting_ttl67 2>/dev/null")
    luci.sys.call("nft delete chain inet fw4 mangle_prerouting_ttl67 2>/dev/null")
    
    local f = io.open(ttl_file, "w")
    if f then
        f:write("")
        f:close()
    end
    
    luci.sys.call("/etc/init.d/firewall restart")
end

function enable_ttl(ttl_value)
    ttl_value = ttl_value or 65
    set_ttl(ttl_value)
end

function render_page()
    local http = require "luci.http"
    local sys = require "luci.sys"
    local tpl = require "luci.template"
    local dispatcher = require "luci.dispatcher"

    local current_ttl = get_current_ttl()
    local ttl_enabled = is_ttl_enabled()

    local action = http.formvalue("action")
    local ttl_value = http.formvalue("ttl_value")
    
    if action == "set_ttl" and ttl_value then
        ttl_value = tonumber(ttl_value)
        if ttl_value and ttl_value >= 1 and ttl_value <= 255 then
            set_ttl(ttl_value)
            current_ttl = ttl_value
            ttl_enabled = true
        end
    elseif action == "disable_ttl" then
        disable_ttl()
        current_ttl = nil
        ttl_enabled = false
    elseif action == "enable_ttl" then
        local enable_ttl_value = tonumber(ttl_value) or current_ttl or 65
        enable_ttl(enable_ttl_value)
        current_ttl = enable_ttl_value
        ttl_enabled = true
    end

    tpl.render("quenx/page", {
        current_ttl = current_ttl or "N/A",
        ttl_value = ttl_value or current_ttl or 65,
        ttl_enabled = ttl_enabled
    })
end
EOL
    }

    buat_page_htm() {
        mkdir -p "$(dirname "$PAGE_HTM")"
        cat <<'EOL' > "$PAGE_HTM"
<%+header%>

<h2>Fix TTL</h2>

<% if ttl_enabled then %>
    <div class="cbi-section">
        <h3 style="color: green;">Status: ON</h3>
    </div>
<% else %>
    <div class="cbi-section">
        <h3 style="color: red;">Status: OFF</h3>
    </div>
<% end %>

<form method="post">
    <div class="cbi-section">
        <label for="ttl_value">Enter TTL Value:</label>
        <input type="number" id="ttl_value" name="ttl_value" min="1" max="255" value="<%= ttl_value %>" required>
    </div>
    <div class="cbi-section" style="display: flex; gap: 10px; align-items: center;">
        <button class="cbi-button cbi-button-apply" type="submit" name="action" value="set_ttl">
            Set TTL
        </button>
        <% if ttl_enabled then %>
            <button class="cbi-button cbi-button-negative" type="submit" name="action" value="disable_ttl">
                Disable
            </button>
        <% else %>
            <button class="cbi-button cbi-button-positive" type="submit" name="action" value="enable_ttl">
                Enable
            </button>
        <% end %>
    </div>
</form>

<div class="cbi-section">
    <p><small>By Quenx | TTL Range: 1-200</small></p>
</div>

<%+footer%>
EOL
    }

    TTL_VALUE="${1:-65}"

    buat_file_ttl "$TTL_VALUE"
    buat_quenx_lua
    buat_page_htm

    log_info "Fix TTL installed successfully"
}

uninstall_fixttl() {
    log_blue "=========================================="
    log_blue "          UNINSTALLING FIX TTL"
    log_blue "=========================================="
    
    log_info "Removing Fix TTL files and folders..."
    
    rm -f /etc/nftables.d/ttl67.nft
    rm -rf /usr/lib/lua/luci/controller/quenx
    rm -rf /usr/lib/lua/luci/view/quenx
    
    log_info "Fix TTL uninstalled successfully"
    log_info "Restarting firewall..."
    /etc/init.d/firewall restart
}

add_port() {
    log_blue "=========================================="
    log_blue "          ADD PORT CONFIGURATION"
    log_blue "                  V1 / V2"
    log_blue "SEBELUM GANTI VERSI RUBAH KE DEFAULT PORT"
    log_blue "=========================================="
    
    log_info "Select menu port configuration:"
    echo "1) Port V1"
    echo "2) Port V2"
    echo "3) Back to Main Menu"
    read -p "Enter your choice [1-3]: " port_choice
    
    case $port_choice in
        1)
            log_blue "=========================================="
            log_blue "          PORT  V1 CONFIGURATION"
            log_blue "    JIKA LUCI ERROR PILIH DEFAULT PORT"
            log_blue "=========================================="
            
            log_info "Select port configuration:"
            echo "1) usb0, eth1"
            echo "2) usb0, eth1, wwan0"
            echo "3) usb0, eth1, phy0-ap0"
            echo "4) usb0, eth1, eth2"
            echo "5) usb0, usb1, eth1, eth2"
            echo "6) eth1, wwan0, wwan1"
            echo "7) usb0, eth1, eth2, wwan0"
            echo "8) br-radius, usb0, eth1, wwan0"
            echo "9) Default Port"
            echo "10) Back to port Menu"
            read -p "Enter your choice [1-10]: " port_choice
            
            case $port_choice in
                1)
                    log_info "Adding ports: usb0, eth1..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		},\
		"wan": {\
			"ports": ["usb0", "eth1"],\
			"protocol": "dhcp"\
		}\
	},' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                2)
                    log_info "Adding ports: usb0, eth1, wwan0..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		},\
		"wan": {\
			"ports": ["usb0", "eth1", "wwan0"],\
			"protocol": "dhcp"\
		}\
	},' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1, wwan0) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                3)
                    log_info "Adding ports: usb0, eth1, phy0-ap0..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		},\
		"wan": {\
			"ports": ["usb0", "eth1", "phy0-ap0"],\
			"protocol": "dhcp"\
		}\
	},' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1, phy0-ap0) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                4)
                    log_info "Adding ports: usb0, eth1, eth2..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		},\
		"wan": {\
			"ports": ["usb0", "eth1", "eth2"],\
			"protocol": "dhcp"\
		}\
	},' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1, eth2) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                5)
                    log_info "Adding ports: usb0, usb1, eth1, eth2..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		},\
		"wan": {\
			"ports": ["usb0", "usb1", "eth1", "eth2"],\
			"protocol": "dhcp"\
		}\
	},' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, usb1, eth1, eth2) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                6)
                    log_info "Adding ports: eth1, wwan0, wwan1..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		},\
		"wan": {\
			"ports": ["eth1", "wwan0", "wwan1"],\
			"protocol": "dhcp"\
		}\
	},' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (eth1, wwan0, wwan1) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                7)
                    log_info "Adding ports: usb0, eth1, eth2, wwan0..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		},\
		"wan": {\
			"ports": ["usb0", "eth1", "eth2", "wwan0"],\
			"protocol": "dhcp"\
		}\
	},' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1, eth2, wwan0) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                8)
                    log_info "Adding ports: br-radius, usb0, eth1, wwan0..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		},\
		"wan": {\
			"ports": ["br-radius", "usb0", "eth1", "wwan0"],\
			"protocol": "dhcp"\
		}\
	},' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (br-radius, usb0, eth1, wwan0) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                9)
                    log_info "Restoring default port configuration..."
                    
                    if [ -f /etc/board.json.backup ]; then
                        cp /etc/board.json.backup /etc/board.json
                        log_info "Default port configuration restored from backup"
                    else
                        log_warn "Backup file not found, creating default configuration..."
                        sed -i '/"network": {/,/},/c\
	"network": {\
		"lan": {\
			"device": "eth0",\
			"protocol": "static"\
		}\
	},' /etc/board.json
                        log_info "Default port configuration restored"
                    fi
                    ;;
                10)
                    log_info "Returning to port menu..."
                    return 0
                    ;;
                *)
                    log_error "Invalid choice. Please select 1-10"
                    return 1
                    ;;
            esac
            ;;
        2)
            log_blue "=========================================="
            log_blue "         PORT V2 CONFIGURATION"
            log_blue "    JIKA LUCI ERROR PILIH DEFAULT PORT"
            log_blue "=========================================="
            
            log_info "Select port configuration:"
            echo "1) usb0, eth1"
            echo "2) usb0, eth1, wwan0"
            echo "3) usb0, eth1, phy0-ap0"
            echo "4) usb0, eth1, eth2"
            echo "5) usb0, usb1, eth1, eth2"
            echo "6) eth1, wwan0, wwan1"
            echo "7) usb0, eth1, eth2, wwan0"
            echo "8) br-radius, usb0, eth1, wwan0"
            echo "9) Default Port"
            echo "10) Back to port Menu"
            read -p "Enter your choice [1-10]: " port_choice
            
            case $port_choice in
                1)
                    log_info "Adding ports: usb0, eth1..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t},\
\t\t"wan": {\
\t\t\t"ports": ["usb0", "eth1"],\
\t\t\t"protocol": "dhcp"\
\t\t}\
\t}/}' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                2)
                    log_info "Adding ports: usb0, eth1, wwan0..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t},\
\t\t"wan": {\
\t\t\t"ports": ["usb0", "eth1", "wwan0"],\
\t\t\t"protocol": "dhcp"\
\t\t}\
\t}/}' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1, wwan0) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                3)
                    log_info "Adding ports: usb0, eth1, phy0-ap0..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t},\
\t\t"wan": {\
\t\t\t"ports": ["usb0", "eth1", "phy0-ap0"],\
\t\t\t"protocol": "dhcp"\
\t\t}\
\t}/}' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1, phy0-ap0) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                4)
                    log_info "Adding ports: usb0, eth1, eth2..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t},\
\t\t"wan": {\
\t\t\t"ports": ["usb0", "eth1", "eth2"],\
\t\t\t"protocol": "dhcp"\
\t\t}\
\t}/}' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1, eth2) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                5)
                    log_info "Adding ports: usb0, usb1, eth1, eth2..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t},\
\t\t"wan": {\
\t\t\t"ports": ["usb0", "usb1", "eth1", "eth2"],\
\t\t\t"protocol": "dhcp"\
\t\t}\
\t}/}' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, usb1, eth1, eth2) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                6)
                    log_info "Adding ports: eth1, wwan0, wwan1..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t},\
\t\t"wan": {\
\t\t\t"ports": ["eth1", "wwan0", "wwan1"],\
\t\t\t"protocol": "dhcp"\
\t\t}\
\t}/}' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (eth1, wwan0, wwan1) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                7)
                    log_info "Adding ports: usb0, eth1, eth2, wwan0..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t},\
\t\t"wan": {\
\t\t\t"ports": ["usb0", "eth1", "eth2", "wwan0"],\
\t\t\t"protocol": "dhcp"\
\t\t}\
\t}/}' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (usb0, eth1, eth2, wwan0) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                8)
                    log_info "Adding ports: br-radius, usb0, eth1, wwan0..."
                    
                    if [ ! -f /etc/board.json.backup ]; then
                        cp /etc/board.json /etc/board.json.backup
                    else
                        cp /etc/board.json.backup /etc/board.json
                    fi
                    
                    sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t},\
\t\t"wan": {\
\t\t\t"ports": ["br-radius", "usb0", "eth1", "wwan0"],\
\t\t\t"protocol": "dhcp"\
\t\t}\
\t}/}' /etc/board.json
                    
                    if [ $? -eq 0 ]; then
                        log_info "Port configuration (br-radius, usb0, eth1, wwan0) applied successfully"
                    else
                        log_error "Port configuration failed"
                        return 1
                    fi
                    ;;
                9)
                    log_info "Restoring default port configuration..."
                    
                    if [ -f /etc/board.json.backup ]; then
                        cp /etc/board.json.backup /etc/board.json
                        log_info "Default port configuration restored from backup"
                    else
                        log_warn "Backup file not found, creating default configuration..."
                        sed -i '/\t"network": {/,/^\t}$/{/^\t}$/!d; s/.*/\t"network": {\
\t\t"lan": {\
\t\t\t"device": "eth0",\
\t\t\t"protocol": "static"\
\t\t}\
\t}/}' /etc/board.json
                        log_info "Default port configuration restored"
                    fi
                    ;;
                10)
                    log_info "Returning to port menu..."
                    return 0
                    ;;
                *)
                    log_error "Invalid choice. Please select 1-10"
                    return 1
                    ;;
            esac
            ;;
        3)
            log_info "Returning to main menu..."
            return 0
            ;;
        *)
            log_error "Invalid choice. Please select 1-3"
            return 1
            ;;
    esac
}

select_wireless_menu() {
    echo ""
    log_blue "${YELLOW}WARNING : Resiko Tanggung Sendiri!!${NC}"
    echo ""
    log_blue "${RED}Untuk Devices Tertentu${NC}"
    echo ""
    log_blue "Select Wireless Menu:"
    echo ""
    echo "  1) Enable WiFi"
    echo "  2) Disable WiFi"
    echo "  0) Back to Main Menu"
    echo ""
    echo -n "Enter choice [0-2]: "
    read wireless_choice
    
    case $wireless_choice in
        1)
            log_blue "=========================================="
            log_blue "              ENABLE WIFI"
            log_blue "=========================================="
            
            log_info "Installing wireless packages..."
            opkg install wpad-openssl iw iwinfo wireless-regdb kmod-cfg80211 kmod-mac80211 &>/dev/null
            
            log_info "Checking wireless configuration..."
            
            if [ ! -f /etc/config/wireless ]; then
                log_warn "Wireless config not found, creating new configuration..."
                
                log_info "Configuring wireless..."
                uci batch &>/dev/null <<EOF
set wireless.@wifi-device[0].disabled='0'
set wireless.@wifi-iface[0].disabled='0'
set wireless.@wifi-iface[0].mode='ap'
set wireless.@wifi-iface[0].encryption='psk2'
set wireless.@wifi-iface[0].key='XIDZs2025'
set wireless.@wifi-device[0].country='ID'
set wireless.@wifi-iface[0].ssid='XIDZs'
set wireless.@wifi-device[0].channel='1'
set wireless.@wifi-device[0].htmode='HT20'
EOF
                uci commit wireless &>/dev/null
                
                log_info "Reloading and starting WiFi..."
                (wifi reload && wifi up) &>/dev/null
                
                log_info "WiFi configured and enabled successfully,please reboot the device"
            fi
            
            echo ""
            echo "Configure Wireless Menu in LuCI:"
            echo "  1) Restore luci menu"
            echo "  2) Add wireless menu"
            echo "  0) Skip menu configuration"
            echo ""
            echo -n "Enter choice [0-2]: "
            read menu_choice
            
            case $menu_choice in
                1)
                    if [ -f /usr/share/luci/menu.d/luci-mod-network.json.backup ]; then
                        log_info "Restoring luci network menu..."
                        cp /usr/share/luci/menu.d/luci-mod-network.json.backup /usr/share/luci/menu.d/luci-mod-network.json
                        log_info "Luci network menu restored successfully"
                    else
                        log_warn "Backup file not found, skipping restore"
                    fi
                    ;;
                2)
                    log_info "Adding wireless to luci menu..."
                    sed -i '16i\	"admin/network/wireless": {\
		"title": "Wireless",\
		"order": 15,\
		"action": {\
			"type": "view",\
			"path": "network/wireless"\
		},\
		"depends": {\
			"acl": [ "luci-mod-network-config" ],\
			"uci": { "wireless": { "@wifi-device": true } }\
		}\
	},' /usr/share/luci/menu.d/luci-mod-network.json
                    log_info "Wireless menu added successfully"
                    ;;
                0)
                    log_info "Skipping menu configuration"
                    ;;
                *)
                    log_warn "Invalid choice, skipping menu configuration"
                    ;;
            esac
            ;;
        2)
            log_blue "=========================================="
            log_blue "              DISABLE WIFI"
            log_blue "=========================================="
            
            log_info "Disabling WiFi devices..."
            
            uci set wireless.@wifi-device[0].disabled='1' &>/dev/null
            uci set wireless.@wifi-iface[0].disabled='1' &>/dev/null
            uci commit wireless &>/dev/null
            wifi down &>/dev/null
            
            log_info "Removing wireless packages..."
            opkg remove --force-depends wpad-openssl iw iwinfo wireless-regdb kmod-cfg80211 kmod-mac80211 &>/dev/null
            
            rm -f /etc/config/wireless
            
            if [ ! -f /usr/share/luci/menu.d/luci-mod-network.json.backup ]; then
                log_info "Backing up luci network menu..."
                cp /usr/share/luci/menu.d/luci-mod-network.json /usr/share/luci/menu.d/luci-mod-network.json.backup
            fi
            
            echo ""
            echo -n "Remove wireless menu from LuCI? (y/n): "
            read remove_menu_choice
            
            case $remove_menu_choice in
                y|Y|yes|Yes|YES)
                    log_info "Removing wireless from luci menu..."
                    sed -i '15,27d' /usr/share/luci/menu.d/luci-mod-network.json
                    log_info "Wireless menu removed successfully"
                    ;;
                n|N|no|No|NO)
                    log_info "Skipping wireless menu remove"
                    ;;
                *)
                    log_warn "Invalid choice, skipping menu remove"
                    ;;
            esac
            
            log_info "WiFi disabled successfully"
            ;;
        0)
            log_info "Returning to main menu..."
            return 0
            ;;
        *)
            log_warn "Invalid choice, returning to menu"
            return 1
            ;;
    esac
}

usbmode_menu() {
    log_blue "=========================================="
    log_blue "                 USB_MODE"
    log_blue "       UNTUK MODEM HP PILIH DISABLE"
    log_blue "=========================================="
    
    echo "1. Enable USB Mode"
    echo "2. Disable USB Mode"
    echo "0. Back to Main Menu"
    echo ""
    read -p "Select option: " usbmode_choice
    
    case $usbmode_choice in
        1)
            enable_usbmode
            ;;
        2)
            disable_usbmode
            ;;
        0)
            return
            ;;
        *)
            log_error "Invalid option"
            ;;
    esac
}

enable_usbmode() {
    log_blue "=========================================="
    log_blue "            ENABLE USB_MODE"
    log_blue "=========================================="
    
    log_info "Enabling USB_MODE..."
    
    if [ -f /etc/usb-mode.backup ]; then
        mv /etc/usb-mode.backup /etc/usb-mode.json
        log_info "USB_MODE enabled successfully"
    else
        log_error "Backup file not found. Please install USB_MODE first"
        return 1
    fi
}

disable_usbmode() {
    log_blue "=========================================="
    log_blue "           DISABLE USB_MODE"
    log_blue "=========================================="
    
    log_info "Disabling USB_MODE..."
    
    if [ -f /etc/usb-mode.json ]; then
        mv /etc/usb-mode.json /etc/usb-mode.backup
        log_info "USB_MODE disabled successfully"
    else
        log_error "USB_MODE is already disabled or not found"
        return 1
    fi
}

select_xidzbot_menu() {
    echo ""
    log_blue "Select BOT XIDZs Menu:"
    echo ""
    echo "  1) Install"
    echo "  2) Uninstall"
    echo "  0) Back to Main Menu"
    echo ""
    echo -n "Enter choice: "
    read xidzbot_choice
    
    case $xidzbot_choice in
        1)
            install_xidzbot
            ;;
        2)
            uninstall_xidzbot
            ;;
        0)
            return 0
            ;;
        *)
            log_warn "Invalid choice, returning to menu"
            return 1
            ;;
    esac
}

install_xidzbot() {
    log_blue "=========================================="
    log_blue "           INSTALLING BOT XIDZs"
    log_blue "=========================================="
    
    log_info "Downloading BOT XIDZs script..."
    
    mkdir -p /tmp/xidzbot
    
    if curl -sL "https://raw.githubusercontent.com/syntax-xidz/contenx/main/xcli/xidzs" -o /tmp/xidzbot/xidzs; then
        log_info "Download xidzs successful"
    else
        log_error "Failed to download xidzs script"
        return 1
    fi
    
    if curl -sL "https://raw.githubusercontent.com/syntax-xidz/contenx/main/xcli/xidz" -o /tmp/xidzbot/xidz; then
        log_info "Download xidz successful"
    else
        log_error "Failed to download xidz script"
        return 1
    fi
    
    if [ -f "/usr/bin/xidz" ] || [ -f "/etc/init.d/xidzs" ]; then
        log_warn "Existing BOT XIDZs installation detected"
        log_info "Stopping existing service..."
        /etc/init.d/xidzs stop 2>/dev/null
        sleep 2
        
        log_info "Removing old files..."
        rm -f /usr/bin/xidz
        rm -f /etc/init.d/xidzs
        log_info "Old installation removed"
    fi
    
    log_info "Moving files to destination folders..."
    mv /tmp/xidzbot/xidz /usr/bin/xidz
    mv /tmp/xidzbot/xidzs /etc/init.d/xidzs
    
    log_info "Setting permissions..."
    chmod 755 /usr/bin/xidz
    chmod 755 /etc/init.d/xidzs
    
    echo ""
    echo -n "Do you want to enable BOT XIDZs at boot? (Yes/No): "
    read boot_choice
    
    if [ "$boot_choice" = "Yes" ] || [ "$boot_choice" = "yes" ] || [ "$boot_choice" = "YES" ]; then
        log_info "Enabling BOT XIDZs at boot..."
        /etc/init.d/xidzs enable
        log_info "BOT XIDZs will start automatically at boot"
    else
        log_info "BOT XIDZs will not start at boot"
        /etc/init.d/xidzs disable
    fi
    
    echo ""
    log_blue "============================================"
    log_blue "          ${RED}INFORMASI XIDZs BOT${NC}"
    log_blue "============================================"
    log_blue "${YELLOW}CONFIGURASI BOT DI /usr/bin/xidz${NC}"
    log_blue "${YELLOW}HAPUS KARAKTER ANEH DI LINE 1${NC}"
    log_blue "${YELLOW}BUAT BOT DULU DI @BotFather${NC}"
    log_blue "${YELLOW}LALU ISI BAGIAN INI ⬇ ︎:${NC}"
    log_blue "${RED}BOT_TOKEN=\"TOKEN\"${NC}"
    log_blue "${RED}CHAT_ID=\"IDTELEGRAM\"${NC}"
    log_blue "============================================"
    log_blue "${YELLOW}START BOT : service xidzs start${NC}"
    log_blue "${YELLOW}STOP BOT : service xidzs stop${NC}"
    log_blue "${YELLOW}ENABLE ON BOOT : service xidzs enable${NC}"
    log_blue "${YELLOW}DISABLE ON BOOT : service xidzs disable${NC}"
    log_blue "============================================"
    echo ""
    
    log_info "BOT XIDZs installed successfully"
    rm -rf /tmp/xidzbot
    log_info "Cleaned up temporary files"
}

uninstall_xidzbot() {
    log_blue "=========================================="
    log_blue "          UNINSTALLING BOT XIDZs"
    log_blue "=========================================="
    
    log_info "Stopping BOT XIDZs service..."
    /etc/init.d/xidzs stop
    
    sleep 2
    
    log_info "Removing BOT XIDZs files..."
    rm -f /usr/bin/xidz
    rm -f /etc/init.d/xidzs
    
    log_info "BOT XIDZs uninstalled successfully"
}

tema_menu() {
    log_blue "=========================================="
    log_blue "            TEMA - TEMA"
    log_blue "=========================================="
    echo ""
    
    log_info "Pilih opsi instalasi tema:"
    echo ""
    log_info "1. Tema Alpha"
    log_info "2. Tema RTAwrt"
    log_info "3. Tema Argon"
    log_info "4. Tema Alpha Reborn"
    log_info "5. Tema Alpha x ALK-NET"
    log_info "6. Install 2 Tema"
    log_info "0. Kembali ke menu utama"
    echo ""
    
    read -p "Masukkan pilihan (0-6): " tema_choice
    
    case $tema_choice in
        1)
            install_tema_alpha
            ;;
        2)
            install_tema_rtawrt
            ;;
        3)
            install_tema_argon
            ;;
        4)
            install_tema_alpha_reborn
            ;;
        5)
            install_tema_alpha_alknet
            ;;
        6)
            install_dua_tema
            ;;
        0)
            log_info "Kembali ke menu utama..."
            return 0
            ;;
        *)
            log_error "Pilihan tidak valid!"
            return 1
            ;;
    esac
}

install_dua_tema() {
    log_blue "=========================================="
    log_blue "         VARIASI TEMA"
    log_blue "=========================================="
    echo ""
    
    log_info "Pilih kombinasi 2 tema yang ingin diinstall:"
    echo ""
    log_info "1. Alpha + RTAwrt"
    log_info "2. Alpha + Argon"
    log_info "3. Alpha + Alpha Reborn"
    log_info "4. Alpha + Alpha x ALK-NET"
    log_info "5. RTAwrt + Argon"
    log_info "6. RTAwrt + Alpha Reborn"
    log_info "7. RTAwrt + Alpha x ALK-NET"
    log_info "8. Argon + Alpha Reborn"
    log_info "9. Argon + Alpha x ALK-NET"
    log_info "10. Alpha Reborn + Alpha x ALK-NET"
    log_info "0. Kembali ke tema menu"
    echo ""
    
    read -p "Masukkan pilihan (0-10): " combo_choice
    
    local tema1_success=0
    local tema2_success=0
    
    case $combo_choice in
        1)
            log_info "Installing Alpha + RTAwrt..."
            echo ""
            install_tema_alpha && tema1_success=1
            echo ""
            install_tema_rtawrt && tema2_success=1
            ;;
        2)
            log_info "Installing Alpha + Argon..."
            echo ""
            install_tema_alpha && tema1_success=1
            echo ""
            install_tema_argon && tema2_success=1
            ;;
        3)
            log_info "Installing Alpha + Alpha Reborn..."
            echo ""
            install_tema_alpha && tema1_success=1
            echo ""
            install_tema_alpha_reborn && tema2_success=1
            ;;
        4)
            log_info "Installing Alpha + Alpha x ALK-NET..."
            echo ""
            install_tema_alpha && tema1_success=1
            echo ""
            install_tema_alpha_alknet && tema2_success=1
            ;;
        5)
            log_info "Installing RTAwrt + Argon..."
            echo ""
            install_tema_rtawrt && tema1_success=1
            echo ""
            install_tema_argon && tema2_success=1
            ;;
        6)
            log_info "Installing RTAwrt + Alpha Reborn..."
            echo ""
            install_tema_rtawrt && tema1_success=1
            echo ""
            install_tema_alpha_reborn && tema2_success=1
            ;;
        7)
            log_info "Installing RTAwrt + Alpha x ALK-NET..."
            echo ""
            install_tema_rtawrt && tema1_success=1
            echo ""
            install_tema_alpha_alknet && tema2_success=1
            ;;
        8)
            log_info "Installing Argon + Alpha Reborn..."
            echo ""
            install_tema_argon && tema1_success=1
            echo ""
            install_tema_alpha_reborn && tema2_success=1
            ;;
        9)
            log_info "Installing Argon + Alpha x ALK-NET..."
            echo ""
            install_tema_argon && tema1_success=1
            echo ""
            install_tema_alpha_alknet && tema2_success=1
            ;;
        10)
            log_info "Installing Alpha Reborn + Alpha x ALK-NET..."
            echo ""
            install_tema_alpha_reborn && tema1_success=1
            echo ""
            install_tema_alpha_alknet && tema2_success=1
            ;;
        0)
            log_info "Kembali ke tema menu..."
            return 0
            ;;
        *)
            log_error "Pilihan tidak valid!"
            return 1
            ;;
    esac
    
    echo ""
    log_blue "=========================================="
    log_blue "        RINGKASAN"
    log_blue "=========================================="
    
    local total_success=$((tema1_success + tema2_success))
    
    if [ $total_success -eq 2 ]; then
        log_info "Kedua tema berhasil diinstall (2/2)"
        return 0
    elif [ $total_success -eq 1 ]; then
        log_warn "Hanya 1 tema berhasil diinstall (1/2)"
        return 1
    else
        log_error "Kedua tema gagal diinstall (0/2)"
        return 1
    fi
}

install_tema_alpha() {
    log_blue "=========================================="
    log_blue "         TEMA ALPHA"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/tema-alpha
    
    log_info "Mengambil versi latest Tema Alpha dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/derisamedia/luci-theme-alpha/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local tema_alpha_url=$(echo "$latest_release" | grep "browser_download_url" | grep "luci-theme-.*alpha" | grep "_all\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$tema_alpha_url" ]; then
        log_error "URL Tema Alpha tidak ditemukan"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "        DOWNLOAD TEMA ALPHA"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$tema_alpha_url")"
    
    if ! download_file "$tema_alpha_url" "/tmp/tema-alpha/luci-theme-alpha.ipk"; then
        log_error "Gagal download Tema Alpha"
        rm -rf /tmp/tema-alpha
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "        INSTALLING TEMA ALPHA"
    log_blue "=========================================="
    
    log_info "Installing Tema Alpha $version..."
    
    if install_package_simple "/tmp/tema-alpha/luci-theme-alpha.ipk"; then
        log_info "Tema Alpha $version berhasil diinstall"
        rm -rf /tmp/tema-alpha
        return 0
    else
        log_error "Gagal install Tema Alpha"
        rm -rf /tmp/tema-alpha
        return 1
    fi
}

install_tema_rtawrt() {
    log_blue "=========================================="
    log_blue "         TEMA RTAWRT"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/tema-rtawrt
    
    log_info "Mengambil versi latest Tema RTAwrt dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/rizkikotet-dev/luci-theme-rtawrt/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local tema_rtawrt_url=$(echo "$latest_release" | grep "browser_download_url" | grep "luci-theme-rtawrt" | grep "_all\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$tema_rtawrt_url" ]; then
        log_error "URL Tema RTAwrt tidak ditemukan"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "        DOWNLOAD TEMA RTAWRT"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$tema_rtawrt_url")"
    
    if ! download_file "$tema_rtawrt_url" "/tmp/tema-rtawrt/luci-theme-rtawrt.ipk"; then
        log_error "Gagal download Tema RTAwrt"
        rm -rf /tmp/tema-rtawrt
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "        INSTALLING TEMA RTAWRT"
    log_blue "=========================================="
    
    log_info "Installing Tema RTAwrt $version..."
    
    if install_package_simple "/tmp/tema-rtawrt/luci-theme-rtawrt.ipk"; then
        log_info "Tema RTAwrt $version berhasil diinstall"
        rm -rf /tmp/tema-rtawrt
        return 0
    else
        log_error "Gagal install Tema RTAwrt"
        rm -rf /tmp/tema-rtawrt
        return 1
    fi
}

install_tema_argon() {
    log_blue "=========================================="
    log_blue "         TEMA ARGON"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/tema-argon
    
    log_info "Mengambil versi latest Tema Argon dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/jerrykuku/luci-theme-argon/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local tema_argon_url=$(echo "$latest_release" | grep "browser_download_url" | grep "luci-theme-argon" | grep "_all\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$tema_argon_url" ]; then
        log_error "URL Tema Argon tidak ditemukan"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "        DOWNLOAD TEMA ARGON"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$tema_argon_url")"
    
    if ! download_file "$tema_argon_url" "/tmp/tema-argon/luci-theme-argon.ipk"; then
        log_error "Gagal download Tema Argon"
        rm -rf /tmp/tema-argon
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "        INSTALLING TEMA ARGON"
    log_blue "=========================================="
    
    log_info "Installing Tema Argon $version..."
    
    if install_package_simple "/tmp/tema-argon/luci-theme-argon.ipk"; then
        log_info "Tema Argon $version berhasil diinstall"
        rm -rf /tmp/tema-argon
        return 0
    else
        log_error "Gagal install Tema Argon"
        rm -rf /tmp/tema-argon
        return 1
    fi
}

install_tema_alpha_reborn() {
    log_blue "=========================================="
    log_blue "      TEMA ALPHA REBORN"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/tema-alpha-reborn
    
    log_info "Mengambil versi latest Tema Alpha Reborn dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/derisamedia/luci-theme-alpha-reborn/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local tema_alpha_reborn_url=$(echo "$latest_release" | grep "browser_download_url" | grep "luci-theme-.*4lpha" | grep "_all\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$tema_alpha_reborn_url" ]; then
        log_error "URL Tema Alpha Reborn tidak ditemukan"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "     DOWNLOAD TEMA ALPHA REBORN"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$tema_alpha_reborn_url")"
    
    if ! download_file "$tema_alpha_reborn_url" "/tmp/tema-alpha-reborn/luci-theme-alpha-reborn.ipk"; then
        log_error "Gagal download Tema Alpha Reborn"
        rm -rf /tmp/tema-alpha-reborn
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "     INSTALLING TEMA ALPHA REBORN"
    log_blue "=========================================="
    
    log_info "Installing Tema Alpha Reborn $version..."
    
    if install_package_simple "/tmp/tema-alpha-reborn/luci-theme-alpha-reborn.ipk"; then
        log_info "Tema Alpha Reborn $version berhasil diinstall"
        rm -rf /tmp/tema-alpha-reborn
        return 0
    else
        log_error "Gagal install Tema Alpha Reborn"
        rm -rf /tmp/tema-alpha-reborn
        return 1
    fi
}

install_tema_alpha_alknet() {
    log_blue "=========================================="
    log_blue "     TEMA ALPHA x ALK-NET"
    log_blue "=========================================="
    echo ""
    
    mkdir -p /tmp/tema-alpha-alknet
    
    log_info "Mengambil versi latest Tema Alpha x ALK-NET dari GitHub..."
    
    local latest_release=$(curl -s "https://api.github.com/repos/derisamedia/luci-theme-alpha-alk-net/releases/latest")
    
    if [ -z "$latest_release" ]; then
        log_error "Gagal mengambil informasi release dari GitHub"
        return 1
    fi
    
    local version=$(echo "$latest_release" | grep '"tag_name":' | head -n 1 | cut -d '"' -f 4)
    
    log_info "Versi latest ditemukan: $version"
    
    local tema_alpha_alknet_url=$(echo "$latest_release" | grep "browser_download_url" | grep "luci-theme-alpha-alk-net" | grep "_all\.ipk" | head -n 1 | cut -d '"' -f 4)
    
    if [ -z "$tema_alpha_alknet_url" ]; then
        log_error "URL Tema Alpha x ALK-NET tidak ditemukan"
        return 1
    fi
    
    log_blue "=========================================="
    log_blue "    DOWNLOAD TEMA ALPHA x ALK-NET"
    log_blue "=========================================="
    
    log_info "Download dari: $(basename "$tema_alpha_alknet_url")"
    
    if ! download_file "$tema_alpha_alknet_url" "/tmp/tema-alpha-alknet/luci-theme-alpha-alknet.ipk"; then
        log_error "Gagal download Tema Alpha x ALK-NET"
        rm -rf /tmp/tema-alpha-alknet
        return 1
    fi
    
    echo ""
    update_package_list_once
    echo ""
    
    log_blue "=========================================="
    log_blue "    INSTALLING TEMA ALPHA x ALK-NET"
    log_blue "=========================================="
    
    log_info "Installing Tema Alpha x ALK-NET $version..."
    
    if install_package_simple "/tmp/tema-alpha-alknet/luci-theme-alpha-alknet.ipk"; then
        log_info "Tema Alpha x ALK-NET $version berhasil diinstall"
        rm -rf /tmp/tema-alpha-alknet
        return 0
    else
        log_error "Gagal install Tema Alpha x ALK-NET"
        rm -rf /tmp/tema-alpha-alknet
        return 1
    fi
}

select_gaya_tema() {
    log_blue "=========================================="
    log_blue "      THEME XIDZs-WRT × ARGON"
    log_blue "=========================================="
    echo ""
    
    log_info "Pilih Gaya Theme Argon"
    echo ""
    log_info "1. Gaya_1 ( Default )"
    log_info "2. Gaya_2 ( Simple )"
    log_info "3. Gaya_3 ( Modern )"
    log_info "0. Kembali ke menu utama"
    echo ""
    
    read -p "Masukkan pilihan (0-3): " gaya_choice
    
    case $gaya_choice in
        1)
            if [ -f "/www/luci-static/argon/gaya/gaya1" ]; then
                rm -f /usr/share/ucode/luci/template/themes/argon/header.ut
                cp /www/luci-static/argon/gaya/gaya1 /usr/share/ucode/luci/template/themes/argon/header.ut
                log_info "Gaya Theme Success Change To Gaya_1 ( Default )"
            else
                log_error "File Gaya_1 tidak ditemukan"
                return 1
            fi
            ;;
        2)
            if [ -f "/www/luci-static/argon/gaya/gaya2" ]; then
                rm -f /usr/share/ucode/luci/template/themes/argon/header.ut
                cp /www/luci-static/argon/gaya/gaya2 /usr/share/ucode/luci/template/themes/argon/header.ut
                log_info "Gaya Theme Success Change To Gaya_2 ( Simple )"
            else
                log_error "File Gaya_2 tidak ditemukan"
                return 1
            fi
            ;;
        3)
            if [ -f "/www/luci-static/argon/gaya/gaya3" ]; then
                rm -f /usr/share/ucode/luci/template/themes/argon/header.ut
                cp /www/luci-static/argon/gaya/gaya3 /usr/share/ucode/luci/template/themes/argon/header.ut
                log_info "Gaya Theme Success Change To Gaya_3 ( Modern )"
            else
                log_error "File Gaya_3 tidak ditemukan"
                return 1
            fi
            ;;
        0)
            log_info "Kembali ke menu utama..."
            return 0
            ;;
        *)
            log_error "Pilihan tidak valid!"
            return 1
            ;;
    esac
}

patch_openclash() {
    log_blue "=========================================="
    log_blue "        PATCH OPENCLASH"
    log_blue "=========================================="
    
    rm -rf /tmp/*openclash* 2>/dev/null
    rm -rf /tmp/*clash* 2>/dev/null
    
    log_info "Downloading PATCH OPENCLASH..."
    
    mkdir -p /tmp/patchoc
    
    if curl -sL "https://raw.githubusercontent.com/syntax-xidz/contenx/main/xcli/oc.zip" -o /tmp/patchoc/oc.zip; then
        log_info "Download patch oc successful"
    else
        log_error "Failed to download patch oc"
        return 1
    fi
    
    if curl -sL "https://raw.githubusercontent.com/syntax-xidz/contenx/main/xcli/oceditor.php" -o /tmp/patchoc/oceditor.php; then
        log_info "Download oceditor successful"
    else
        log_error "Failed to download oceditor"
        return 1
    fi
    
    log_info "Checking oceditor.php..."
    if [ -f "/www/tinyfm/oceditor.php" ]; then
        log_info "oceditor.php found, skipp"
    else
        log_info "oceditor.php not found"
        cp /tmp/patchoc/oceditor.php /www/tinyfm/
    fi
    
    rm -f /usr/share/openclash/{clash_version.sh,openclash_version.sh,openclash_core.sh,openclash_update.sh}
    
    unzip -oq /tmp/patchoc/oc.zip -d /usr/share/openclash/
    
    find /usr/share/openclash/ -name "*.sh" -exec chmod 755 {} \;
    
    log_info "Patching OpenClash config editor..."
    
    CONT="/usr/lib/lua/luci/controller/openclash.lua"
    
    if ! grep -q "Config Editor" $CONT && [ -f "/www/tinyfm/tinyfm.php" ]; then
        sed -i '87 i\	entry({"admin", "services", "openclash", "editor"}, template("openclash/editor"),_("Config Editor"), 90).leaf = true' $CONT
        cat << EOF > /usr/lib/lua/luci/view/openclash/editor.htm
<%+header%>
<div class="cbi-map">
<iframe id="editor" style="width: 100%; min-height: 100vh; border: none; border-radius: 2px;"></iframe>
</div>
<script type="text/javascript">
document.getElementById("editor").src = "http://" + window.location.hostname + "/tinyfm/tinyfm.php?p=etc/openclash";
</script>
<%+footer%>
EOF
    elif grep -q "Config Editor" $CONT && [ ! -f "/www/tinyfm/tinyfm.php" ]; then
        sed -i '/Config Editor/d' $CONT
    fi
    log_info "Config editor patch completed"
    
    rm -rf /tmp/patchoc
    
    log_info "Patch OpenClash applied successfully"
}

remove_app_folders() {
    local app="$1"
    
    echo ""
    log_blue "Hapus folder dan konfigurasi $app?"
    echo ""
    echo "  1) Ya - Hapus semua data"
    echo "  2) Tidak - Simpan konfigurasi"
    echo ""
    echo -e "${YELLOW}Auto-pilih 'Simpan' dalam 5 detik...${NC}"
    echo ""
    echo -n "Pilih [1-2]: "
    
    if read -t 5 config_choice; then
        echo ""
        if [ "$config_choice" = "1" ]; then
            case "$app" in
                luci-app-openclash)
                    rm -rf /etc/openclash 2>/dev/null
                    rm -f /etc/config/openclash 2>/dev/null
                    rm -rf /usr/share/openclash 2>/dev/null
                    log_info "Konfigurasi OpenClash Tunnel dihapus"
                    ;;
                nikki)
                    rm -f /etc/config/nikki 2>/dev/null
                    rm -f /usr/bin/mihomo 2>/dev/null
                    rm -rf /etc/nikki 2>/dev/null
                    log_info "Konfigurasi Nikki Tunnel dihapus"
                    ;;
                luci-app-nikki)
                    rm -f /etc/config/nikki 2>/dev/null
                    rm -f /usr/bin/mihomo 2>/dev/null
                    rm -rf /etc/nikki 2>/dev/null
                    log_info "Konfigurasi Nikki Tunnel dihapus"
                    ;;
                insomclash)
                    rm -f /etc/config/insomclash 2>/dev/null
                    rm -f /usr/bin/mihomo 2>/dev/null
                    rm -rf /etc/insomclash 2>/dev/null
                    log_info "Konfigurasi Insomclash Tunnel dihapus"
                    ;;
                luci-app-insomclash)
                    rm -f /etc/config/insomclash 2>/dev/null
                    rm -f /usr/bin/mihomo 2>/dev/null
                    rm -rf /etc/insomclash 2>/dev/null
                    log_info "Konfigurasi Insomclash Tunnel dihapus"
                    ;;
                luci-app-passwall)
                    rm -f /etc/config/passwall 2>/dev/null
                    rm -rf /usr/share/passwall 2>/dev/null
                    rm -rf /etc/passwall 2>/dev/null
                    log_info "Konfigurasi PassWall Tunnel dihapus"
                    ;;
                bandix)
                    rm -f /etc/config/bandix 2>/dev/null
                    rm -rf /etc/bandix 2>/dev/null
                    log_info "Konfigurasi Bandix Tools dihapus"
                    ;;
                luci-app-bandix)
                    rm -f /etc/config/bandix 2>/dev/null
                    rm -rf /etc/bandix 2>/dev/null
                    log_info "Konfigurasi Bandix Tools dihapus"
                    ;;
                luci-app-netmonitor)
                    rm -f /etc/config/netmonitor 2>/dev/null
                    rm -rf /etc/netmonitor 2>/dev/null
                    log_info "Konfigurasi Netmonitor Tools dihapus"
                    ;;
                modemdata)
                    rm -f /etc/config/modemdata 2>/dev/null
                    rm -rf /etc/modemdata 2>/dev/null
                    log_info "Konfigurasi Modemdata Tools dihapus"
                    ;;
                luci-app-modemdata)
                    rm -f /etc/config/modemdata 2>/dev/null
                    rm -rf /etc/modemdata 2>/dev/null
                    log_info "Konfigurasi Modemdata Tools dihapus"
                    ;;
                webdroidx)
                    rm -f /etc/config/webdroidx 2>/dev/null
                    log_info "Konfigurasi Webdroidx Tools dihapus"
                    ;;
                andromodem)
                    rm -f /etc/config/andromodem 2>/dev/null
                    log_info "Konfigurasi Andromodem Tools dihapus"
                    ;;
                luci-app-andromodem)
                    rm -f /etc/config/andromodem 2>/dev/null
                    log_info "Konfigurasi Andromodem Tools dihapus"
                    ;;
            esac
        else
            log_info "Konfigurasi disimpan"
        fi
    else
        echo ""
        log_info "Auto-pilih: Konfigurasi disimpan"
    fi
}

uninstall_app() {
    local pkg="$1"
    log_blue "=========================================="
    log_blue "        UNINSTALL ${pkg^^}"
    log_blue "=========================================="
    
    echo ""
    log_info "Mengambil packages terkait $pkg..."
    
    local related_packages=($(get_related_packages "$pkg"))
    
    if [ ${#related_packages[@]} -eq 0 ]; then
        case "$pkg" in
            luci-app-openclash|nikki|luci-app-nikki|insomclash|luci-app-insomclash|luci-app-passwall)
                log_warn "Tidak ada Tunnel $pkg yang terinstall"
                ;;
            bandix|luci-app-bandix|luci-app-netmonitor|modemdata|luci-app-modemdata|webdroidx|andromodem|luci-app-andromodem)
                log_warn "Tidak ada Tools $pkg yang terinstall"
                ;;
        esac
        return 1
    fi
    
    echo ""
    log_info "Packages yang akan dihapus:"
    for pkg_name in "${related_packages[@]}"; do
        echo "  - $pkg_name"
    done
    
    echo ""
    echo -n "Remove configurasi: "
    
    remove_app_folders "$pkg"
    
    echo ""
    local removed_count=0
    local failed_count=0
    
    for pkg_name in "${related_packages[@]}"; do
        if uninstall_package_with_fallback "$pkg_name"; then
            ((removed_count++))
        else
            ((failed_count++))
        fi
    done
    
    echo ""
    log_info "Hasil uninstall:"
    log_info "  - Berhasil: $removed_count packages"
    if [ $failed_count -gt 0 ]; then
        log_warn "  - Gagal: $failed_count packages"
    fi
    
    if [ $removed_count -gt 0 ]; then
        case "$pkg" in
            luci-app-openclash|nikki|luci-app-nikki|insomclash|luci-app-insomclash|luci-app-passwall)
                log_info "$pkg Tunnel berhasil dihapus"
                ;;
            bandix|luci-app-bandix|luci-app-netmonitor|modemdata|luci-app-modemdata|webdroidx|andromodem|luci-app-andromodem)
                log_info "$pkg Tools berhasil dihapus"
                ;;
        esac
        return 0
    else
        case "$pkg" in
            luci-app-openclash|nikki|luci-app-nikki|insomclash|luci-app-insomclash|luci-app-passwall)
                log_error "Gagal menghapus $pkg Tunnel"
                ;;
            bandix|luci-app-bandix|luci-app-netmonitor|modemdata|luci-app-modemdata|webdroidx|andromodem|luci-app-andromodem)
                log_error "Gagal menghapus $pkg Tools"
                ;;
        esac
        return 1
    fi
}

handle_uninstall() {
    show_banner
    echo ""
    
    log_blue "=========================================="
    log_blue "         UNINSTALL TUNNELS & TOOLS"
    log_blue "=========================================="
    
    echo ""
    log_info "Memeriksa packages yang terinstall..."
    
    local apps=("luci-app-openclash" "luci-app-passwall" "nikki" "luci-app-nikki" "insomclash" "luci-app-insomclash" "bandix" "luci-app-bandix" "luci-app-netmonitor" "modemdata" "luci-app-modemdata" "webdroidx" "andromodem" "luci-app-andromodem")
    local installed_apps=()
    
    for app in "${apps[@]}"; do
        if is_package_installed "$app"; then
            installed_apps+=("$app")
        fi
    done
    
    if [ ${#installed_apps[@]} -eq 0 ]; then
        log_warn "Tidak ada Tunnel atau Tools yang terinstall"
        echo ""
        echo -n "Tekan Enter untuk melanjutkan..."
        read
        return
    fi
    
    echo ""
    log_info "Packages yang terinstall:"
    for i in "${!installed_apps[@]}"; do
        local app_name="${installed_apps[$i]}"
        case "$app_name" in
            luci-app-openclash) app_display="OpenClash (Tunnel)" ;;
            luci-app-passwall) app_display="PassWall (Tunnel)" ;;
            nikki) app_display="Nikki (Tunnel)" ;;
            luci-app-nikki) app_display="Luci Nikki (Tunnel)" ;;
            insomclash) app_display="InsomClash (Tunnel)" ;;
            luci-app-insomclash) app_display="Luci InsomClash (Tunnel)" ;;
            bandix) app_display="Bandix (Tools)" ;;
            luci-app-bandix) app_display="Luci Bandix (Tools)" ;;
            luci-app-netmonitor) app_display="Netmonitor (Tools)" ;;
            modemdata) app_display="Modemdata (Tools)" ;;
            luci-app-modemdata) app_display="Luci Modemdata (Tools)" ;;
            webdroidx) app_display="Webdroidx (Tools)" ;;
            andromodem) app_display="Andromodem (Tools)" ;;
            luci-app-andromodem) app_display="Luci Andromodem (Tools)" ;;
            *) app_display="$app_name" ;;
        esac
        echo "  $((i+1))) $app_display"
    done
    
    echo ""
    echo "  $((${#installed_apps[@]}+1))) Uninstall Semua"
    echo "  0) Batal"
    echo ""
    echo -n "Pilih [0-$((${#installed_apps[@]}+1))]: "
    read uninstall_choice
    
    if [ "$uninstall_choice" = "0" ]; then
        log_info "Uninstall dibatalkan"
        return
    elif [ "$uninstall_choice" = "$((${#installed_apps[@]}+1))" ]; then
        echo ""
        log_blue "=========================================="
        log_blue "        UNINSTALL ALL TUNNELS & TOOLS"
        log_blue "=========================================="
        
        local uninstall_count=0
        local tunnel_count=0
        local tools_count=0
        
        for app in "${installed_apps[@]}"; do
            echo ""
            if uninstall_app "$app"; then
                ((uninstall_count++))
                case "$app" in
                    luci-app-openclash|nikki|luci-app-nikki|insomclash|luci-app-insomclash|luci-app-passwall)
                        ((tunnel_count++))
                        ;;
                    bandix|luci-app-bandix|luci-app-netmonitor|modemdata|luci-app-modemdata|webdroidx|andromodem|luci-app-andromodem)
                        ((tools_count++))
                        ;;
                esac
            fi
        done
        
        echo ""
        log_info "Total berhasil dihapus: $uninstall_count dari ${#installed_apps[@]} Packages"
        log_info "  - Tunnels: $tunnel_count"
        log_info "  - Tools: $tools_count"
    elif [ "$uninstall_choice" -ge 1 ] && [ "$uninstall_choice" -le "${#installed_apps[@]}" ]; then
        local selected_app="${installed_apps[$((uninstall_choice-1))]}"
        echo ""
        uninstall_app "$selected_app"
    else
        log_error "Pilihan tidak valid: $uninstall_choice"
    fi
    
    echo ""
    echo -n "Tekan Enter untuk melanjutkan..."
    read
}

main() {
    while true; do
        show_menu
        read choice
        
        case $choice in
            1)
                show_banner
                check_dependencies
                auto_setup_config
                select_core_version
                echo ""
                repair_opkg_database
                echo ""
                if install_openclash; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            2)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                if install_passwall; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            3)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                if install_nikki; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            4)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                if install_insomclash; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            5)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                if install_nikki; then
                    echo ""
                    install_insomclash
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            6)
                show_banner
                check_dependencies
                auto_setup_config
                select_core_version
                echo ""
                repair_opkg_database
                echo ""
                if install_openclash; then
                    echo ""
                    install_nikki
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            7)
                show_banner
                check_dependencies
                auto_setup_config
                select_core_version
                echo ""
                repair_opkg_database
                echo ""
                if install_openclash; then
                    echo ""
                    install_insomclash
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            8)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                if install_passwall; then
                    echo ""
                    install_nikki
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            9)
                show_banner
                check_dependencies
                auto_setup_config
                select_core_version
                echo ""
                repair_opkg_database
                echo ""
                if install_openclash; then
                    echo ""
                    install_passwall
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            10)
                show_banner
                check_dependencies
                auto_setup_config
                select_core_version
                echo ""
                repair_opkg_database
                echo ""
                log_blue "=========================================="
                log_blue "           INSTALL ALL TUNNELS"
                log_blue "=========================================="
                
                local install_count=0
                local tunnel_count=0
                
                if install_openclash; then
                    ((install_count++))
                    ((tunnel_count++))
                fi
                
                echo ""
                if install_passwall; then
                    ((install_count++))
                    ((tunnel_count++))
                fi
                
                echo ""
                if install_nikki; then
                    ((install_count++))
                    ((tunnel_count++))
                fi
                
                echo ""
                if install_insomclash; then
                    ((install_count++))
                    ((tunnel_count++))
                fi
                
                restart_services
                
                echo ""
                log_info "Total berhasil diinstall: $install_count dari 4 Tunnel"
                log_info "  - Tunnels: $tunnel_count dari 4"
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            11)
                download_openclash_core
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            12)
                download_nikki_core
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            13)
                download_insomclash_core
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            14)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                if install_bandix; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            15)
                show_banner
                check_dependencies
                echo ""
                repair_opkg_database
                echo ""
                if install_netmonitor; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            16)
                show_banner
                check_dependencies
                echo ""
                repair_opkg_database
                echo ""
                if install_modemdata; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            17)
                show_banner
                check_dependencies
                echo ""
                repair_opkg_database
                echo ""
                if install_webdroidx; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            18)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                if install_andromodem; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            19)
                show_banner
                check_dependencies
                echo ""
                repair_opkg_database
                echo ""
                if rakitanmanager_menu; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            20)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                if adguardhome_menu; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            21)
                show_banner
                check_dependencies
                auto_setup_config
                echo ""
                repair_opkg_database
                echo ""
                log_blue "=========================================="
                log_blue "            INSTALL ALL TOOLS"
                log_blue "=========================================="
                
                local install_count=0
                local tools_count=0
                
                if install_bandix; then
                    ((install_count++))
                    ((tools_count++))
                fi
                
                echo ""
                if install_netmonitor; then
                    ((install_count++))
                    ((tools_count++))
                fi
                
                echo ""
                if install_modemdata; then
                    ((install_count++))
                    ((tools_count++))
                fi
                
                restart_services
                
                echo ""
                log_info "Total berhasil diinstall: $install_count dari 3 Tools"
                log_info "  - Tools: $tools_count dari 3"
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            22)
                show_banner
                if select_fixttl_menu; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            23)
                show_banner
                if add_port; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            24)
                show_banner
                if usbmode_menu; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            25)
                show_banner
                if patch_openclash; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            26)
                show_banner
                echo ""
                repair_opkg_database
                echo ""
                if select_wireless_menu; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            27)
                show_banner
                if select_xidzbot_menu; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            28)
                show_banner
                check_dependencies
                echo ""
                repair_opkg_database
                echo ""
                if tema_menu; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            29)
                show_banner
                if select_gaya_tema; then
                    restart_services
                fi
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
            30)
                handle_uninstall
                ;;
            0)
                clear
                echo ""
                log_blue "=========================================="
                log_blue "             TERIMA KASIH!"
                log_blue "=========================================="
                echo ""
                log_info "XDEVTools v2.6 | XIDZs-WRT PROJECT"
                echo ""
                exit 0
                ;;
            *)
                log_error "Pilihan tidak valid: $choice"
                echo ""
                echo -n "Tekan Enter untuk melanjutkan..."
                read
                ;;
        esac
    done
}

if [ "$(id -u)" != "0" ]; then
    log_error "Script ini harus dijalankan sebagai root"
    exit 1
fi

if ! command -v opkg &> /dev/null; then
    log_error "OPKG tidak ditemukan. Script ini hanya untuk OS OpenWRT"
    exit 1
fi

main "$@"
